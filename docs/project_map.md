# Tmux-FSM 项目结构分析

## 项目概述
Tmux-FSM 是一个为 Tmux 提供 Vim 风格模态编辑的插件。该项目采用模块化架构，实现了从按键输入到编辑操作的完整处理链路。

## 项目结构

```
Tmux-FSM/
├── backend/          # Tmux 后端交互组件
├── cmd/              # 命令行工具
├── crdt/             # 冲突无关数据类型
├── docs/             # 文档
├── editor/           # 编辑器核心组件
├── engine/           # 引擎组件
├── examples/         # 示例代码
├── fsm/              # 有限状态机核心
├── index/            # 索引相关组件
├── intent/           # 意图处理
├── invariant/        # 不变式验证
├── kernel/           # 核心处理内核
├── legacy/           # 遗留代码
├── pkg/              # 通用包
├── planner/          # 计划器
├── policy/           # 策略管理
├── replay/           # 操作重放
├── selection/        # 选择管理
├── semantic/         # 语义分析
├── tests/            # 测试代码
├── tools/            # 开发工具
├── types/            # 类型定义
├── ui/               # 用户界面
├── undotree/         # 撤销树
├── verifier/         # 验证器
├── wal/              # 预写日志
├── weaver/           # Weaver 系统（新的执行引擎）
├── client.go         # 客户端网络通信
├── config.go         # 配置管理
├── engine.go         # 光标引擎
├── globals.go        # 全局变量和状态
├── intent.go         # 意图定义
├── intent_bridge.go  # 意图桥接（新旧系统兼容）
├── keymap.yaml       # 键位映射配置
├── logic.go          # FSM 逻辑处理
├── main.go           # 主程序入口
├── transaction.go    # 事务处理
├── text_object.go    # 文本对象处理
├── protocol.go       # 通信协议
├── resolver_integration.go # 解析器集成
└── ...
```

## 核心模块分析

### 1. main.go - 主程序入口
- **功能**: 程序入口，包含服务器/客户端模式、命令行参数处理
- **职责**: 
  - 初始化 FSM 引擎、内核和 Weaver 系统
  - 管理服务器模式下的 Unix 域套接字通信
  - 处理命令行参数（enter/exit/reload 等）
  - 实现事务管理和宏管理功能

### 2. fsm/ - 有限状态机模块
- **engine.go**: FSM 引擎，处理状态转换和按键分发
- **keymap.go**: 键位映射配置解析和管理
- **nvim.go**: Neovim 模式集成
- **功能**: 管理 FSM 状态（NAV, GOTO 等层）、处理按键输入、状态转换

### 3. kernel/ - 核心处理内核
- **kernel.go**: 核心处理逻辑，连接 FSM 和执行器
- **intent_executor.go**: 意图执行器接口
- **resolver_executor.go**: 解析器执行器
- **功能**: 统一处理按键输入，决定是通过 FSM 还是直接执行意图

### 4. editor/ - 编辑器组件
- **engine.go**: 编辑引擎
- **execution_context.go**: 执行上下文
- **stores.go**: 缓冲区、窗口、选择区存储
- **功能**: 实现具体的编辑操作（移动、删除、插入等）

### 5. weaver/ - Weaver 系统（新执行引擎）
- **core/**: Weaver 核心组件
- **manager/**: Weaver 管理器
- **adapter/**: 适配器层
- **功能**: 新的意图执行系统，提供更安全和可预测的编辑操作

### 6. intent/ - 意图系统
- **intent.go**: 意图定义和类型
- **功能**: 将按键序列转换为语义意图

## 依赖关系图

```
┌─────────────────┐
│   main.go       │
│  (入口/协调)    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐    ┌─────────────────┐
│   kernel/       │────│   fsm/          │
│  (核心内核)     │    │  (状态机)       │
└─────────┬───────┘    └─────────────────┘
          │                         │
          ▼                         ▼
┌─────────────────┐         ┌─────────────────┐
│   weaver/       │         │   editor/       │
│  (执行引擎)     │         │  (编辑操作)     │
└─────────┬───────┘         └─────────────────┘
          │                         │
          ▼                         ▼
┌─────────────────┐         ┌─────────────────┐
│   backend/      │         │   types/        │
│  (Tmux交互)     │         │  (类型定义)     │
└─────────────────┘         └─────────────────┘

┌─────────────────┐
│   intent/       │
│  (意图系统)     │
└─────────────────┘

┌─────────────────┐
│   protocol.go   │
│  (通信协议)     │
└─────────────────┘

┌─────────────────┐
│   transaction.go│
│  (事务管理)     │
└─────────────────┘
```

## 架构模式

### 1. 分层架构
- **表现层**: main.go, fsm/ (处理用户输入和状态管理)
- **业务逻辑层**: kernel/, weaver/ (处理意图和执行逻辑)
- **执行层**: editor/, backend/ (执行具体操作)
- **数据层**: types/, transaction.go (数据结构和事务)

### 2. 事件驱动架构
- 按键事件 → FSM → Intent → Kernel → Executor

### 3. 插件化设计
- Weaver 系统作为可插拔的执行引擎
- IntentExecutor 接口支持多种执行器实现

## 关键设计模式

1. **状态机模式**: FSM 模块管理不同编辑状态
2. **命令模式**: Intent 表示用户的编辑意图
3. **适配器模式**: Weaver 适配器层连接不同系统
4. **观察者模式**: FSM 引擎通知状态变化
5. **单例模式**: 全局状态和引擎实例

## 通信协议

- **客户端-服务器**: Unix 域套接字
- **协议格式**: `requestID|actorID|paneAndClient|key`
- **支持格式**: JSON 和字符串协议

## 配置管理

- **keymap.yaml**: 键位映射配置
- **环境变量**: 执行模式、日志记录等配置

## 事务和历史管理

- **TransactionManager**: 管理编辑操作历史
- **TxJournal**: 事务日志，支持撤销/重做
- **MacroManager**: 宏录制和播放

## 扩展性考虑

1. **Weaver 系统**: 新的执行引擎，提供更安全的编辑操作
2. **Intent 系统**: 语义化意图，便于扩展新功能
3. **模块化设计**: 各组件职责分离，便于独立开发和测试
4. **兼容性桥接**: 保持与旧系统的兼容性

## 项目特点

1. **模态编辑**: Vim 风格的模态编辑体验
2. **状态管理**: 复杂的状态机管理
3. **意图系统**: 将按键转换为语义意图
4. **安全执行**: Weaver 系统提供安全的执行环境
5. **事务管理**: 支持撤销/重做和宏功能
6. **可扩展性**: 模块化设计支持功能扩展