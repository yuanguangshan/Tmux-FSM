##### --------------------------------------------------
##### Core / Terminal
##### --------------------------------------------------

set -g default-terminal "screen-256color"
set -as terminal-overrides ",xterm-256color:RGB"

set -g mouse on
set -g history-limit 50000
set -sg escape-time 10
set -g set-clipboard on


##### --------------------------------------------------
##### Prefix / Index
##### --------------------------------------------------

set -g prefix C-a
unbind C-b
bind C-a send-prefix

set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on


##### --------------------------------------------------
##### Windows / Panes (inherit cwd)
##### --------------------------------------------------

bind c new-window -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

bind x kill-pane
bind X kill-window
bind q kill-pane

bind w list-windows
bind Tab last-window

bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5


##### --------------------------------------------------
##### Pane Navigation (Vim-style)
##### --------------------------------------------------

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R


##### --------------------------------------------------
##### Vim / Neovim Smart Pass-through (FAST)
##### --------------------------------------------------

is_vim='#{pane_current_command} =~ "^(vim|nvim|vi)$"'

bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-h previous-window


##### --------------------------------------------------
##### Copy Mode (vi + system clipboard)
##### --------------------------------------------------

setw -g mode-keys vi

if-shell 'command -v pbcopy' \
  'set -g @clip_copy "pbcopy"' \
  'set -g @clip_copy "xclip -selection clipboard"'

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection \;\
  run "tmux save-buffer - | #{@clip_copy}"
bind -T copy-mode-vi r send -X rectangle-toggle
bind -T copy-mode-vi n send -X search-next
bind -T copy-mode-vi N send -X search-previous
bind -T copy-mode-vi Escape send -X cancel

bind P paste-buffer


##### --------------------------------------------------
##### Status Bar (Clean)
##### --------------------------------------------------

set -g status on
set -g status-position bottom
set -g status-interval 2

set -g status-style fg=colour250,bg=colour234
set -g status-left-length 40
set -g status-right-length 80

set -g window-status-style fg=colour245,bg=colour234
set -g window-status-current-style fg=colour234,bg=colour39,bold
set -g window-status-separator " | "

set -g window-status-format " #I:#W "
set -g window-status-current-format "▶#I:#W◀"

# FSM 状态（由插件维护）
set -g status-right "#{@fsm_state}#{@fsm_keys} | #S | %Y-%m-%d %H:%M"


##### --------------------------------------------------
##### Reload
##### --------------------------------------------------

bind r source-file ~/.tmux.conf \; display "tmux reloaded"


##### --------------------------------------------------
##### FSM Plugin (Isolated)
##### --------------------------------------------------

# No-prefix FSM toggle
set -g @fsm_bind_no_prefix "C-f"

source-file "$HOME/.tmux/plugins/tmux-fsm/plugin.tmux"
