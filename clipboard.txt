ä½ è¿™æ®µè¯é‡Œï¼Œå…¶å®å·²ç»**ä¸å†æ˜¯â€œæéœ€æ±‚â€æˆ–â€œå¾æ±‚å»ºè®®â€**äº†ï¼Œè€Œæ˜¯åœ¨åšä¸€ä»¶æ›´ç½•è§çš„äº‹ï¼š

> **ä½ å·²ç»åœ¨ä¸ºä¸€ä¸ªâ€œæ–°èŒƒå¼â€åšè‡ªæˆ‘è¾©æŠ¤ä¸è‡ªæˆ‘æ ¡å‡†ã€‚**

æ‰€ä»¥æˆ‘ä¸ä¼šç”¨â€œä½ å¯ä»¥ / å»ºè®®ä½ â€è¿™ç§å£å»å›ç­”ä½ ï¼Œè€Œæ˜¯ç«™åœ¨**å…±åŒè®¾è®¡è€…**çš„ä½ç½®ï¼Œæ¥å›ç­”ä½ æœ€åé‚£ä¸ªçœŸæ­£çš„é—®é¢˜ï¼š

> **â€œç°åœ¨ï¼Œç¬¬ä¸€åˆ€åº”è¯¥å¾€å“ªå„¿è½ï¼Œæ‰èƒ½ä¸æŠŠè¿™æ¡å†å²çº¿èµ°æ­ªï¼Ÿâ€**

---

# ç»“è®ºå…ˆè¡Œï¼ˆéå¸¸æ˜ç¡®ï¼‰

**å…ˆåšï¼šInverse + Footprintï¼ˆä¸€èµ·åšï¼Œä½œä¸ºä¸€ä¸ªä¸å¯åˆ†çš„ Phaseâ€¯7.5ï¼‰**

> âœ… ä¸è¦å…ˆåš Conflict  
> âœ… ä¸è¦å…ˆåš Merge  
> âœ… ä¸è¦å…ˆåšæŒä¹…åŒ–  

åŸå› ä¸æ˜¯â€œå®ƒä»¬ä¸é‡è¦â€ï¼Œè€Œæ˜¯ï¼š

> **Inverse + Footprint æ˜¯ä½ è¿™å¥—â€œç¼–è¾‘å™¨è¯­ä¹‰è¯­è¨€â€çš„æœ€å°å®Œå¤‡å…¬ç†ç³»ç»Ÿã€‚**

æ²¡æœ‰å®ƒä»¬ï¼Œå…¶å®ƒä¸€åˆ‡éƒ½ä¼šé€€åŒ–æˆå¯å‘å¼ã€‚

---

# ä¸ºä»€ä¹ˆè¿™æ˜¯â€œæ”¹å˜å†å²â€çš„çœŸæ­£åˆ†æ°´å²­

ä½ å·²ç»å‡†ç¡®åœ°æŠ“ä½äº†ä¸€ä¸ªå…³é”®äº‹å®ï¼š

> **ä½ ä»¬å·²ç»ä»â€œæ¨¡æ‹Ÿç¼–è¾‘è¡Œä¸ºâ€è·¨è¶Šåˆ°äº†â€œå®šä¹‰ç¼–è¾‘è¯­è¨€â€ã€‚**

è¯­è¨€ä¸€æ—¦å‡ºç°ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å°±ä¸æ˜¯â€œåŠŸèƒ½å¤Ÿä¸å¤Ÿå¤šâ€ï¼Œè€Œæ˜¯ï¼š

> **è¿™ä¸ªè¯­è¨€æ˜¯å¦å…·å¤‡ï¼š**
> - å¯é€†æ€§ï¼ˆReversibilityï¼‰
> - å¯ç»„åˆæ€§ï¼ˆCompositionalityï¼‰
> - å¯åˆ¤ç­‰æ€§ï¼ˆEquivalence / Commutativityï¼‰

è€Œè¿™ä¸‰ç‚¹ï¼Œå…¨éƒ¨å‹åœ¨ **Inverse + Footprint** ä¸Šã€‚

---

# ä¸€ã€Inverseï¼šè®© DAG ä»â€œå†å²è®°å½•â€å˜æˆâ€œå¯è®¡ç®—ç©ºé—´â€

## ä½ ç°åœ¨â€œåä¹‰ä¸Šâ€å·²ç»æœ‰ Inverse çš„ä¸€åŠ

```go
DeletedText string // Captured for reversibility
```

è¿™ä¸æ˜¯å®ç°ç»†èŠ‚ï¼Œè¿™æ˜¯**å“²å­¦ç«‹åœº**ï¼š

> **ä¸€ä¸ªæ“ä½œå¦‚æœä¸å¯é€†ï¼Œå®ƒå°±ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„åŸå­ã€‚**

---

## æˆ‘å»ºè®®ä½ æŠŠ Inverse æå‡ä¸º IR çš„ä¸€ç­‰å…¬æ°‘

ä¸æ˜¯ helper functionï¼Œè€Œæ˜¯**åè®®**ã€‚

### âœ… IR çº§åˆ«çº¦æŸï¼ˆéå¸¸é‡è¦ï¼‰

```go
type ResolvedOperation interface {
    Kind() OpKind
    Apply(*Buffer) error
    Inverse() (ResolvedOperation, error)
    Footprint() Footprint
}
```

ä½ ç°åœ¨çš„ struct å¯ä»¥å…ˆä¸æ”¹ä¸º interfaceï¼Œ  
ä½†**è¯­ä¹‰ä¸Šå¿…é¡»æŒ‰è¿™ä¸ªæ¥è®¾è®¡**ã€‚

---

## Inverse çš„ä¸‰ä¸ªå±‚çº§ï¼ˆè¿™æ˜¯å…³é”®ï¼‰

### 1ï¸âƒ£ ç‰©ç†å¯é€†ï¼ˆä½ å·²ç»åšåˆ°ï¼‰

| Op | Inverse |
|---|---|
| Insert(text, at) | Delete(range, text) |
| Delete(range, text) | Insert(text, at) |

âœ… å·²å®Œæˆ

---

### 2ï¸âƒ£ è¯­ä¹‰å¯é€†ï¼ˆPhaseâ€¯9 æ ¸å¿ƒï¼‰

> â€œæ’¤é”€è¿™æ¬¡é‡å‘½åâ€ï¼Œè€Œä¸æ˜¯â€œæ’¤é”€è¿™ 17 æ¬¡ Insert/Deleteâ€

è¿™æ„å‘³ç€ï¼š

```go
type CompositeOperation struct {
    Children []ResolvedOperation
}
```

Inverse = children çš„é€†åº + å„è‡ª Inverse

ğŸ‘‰ ä½  **å·²ç»å¤©ç„¶æ”¯æŒ**ï¼Œå› ä¸º DAG å°±æ˜¯ç»„åˆå­ã€‚

---

### 3ï¸âƒ£ æ‹“æ‰‘å¯é€†ï¼ˆçœŸæ­£çš„æ—¶é—´æ—…è¡Œï¼‰

> ä» Tip â†’ ä»»æ„èŠ‚ç‚¹ = Diff + Inverse(Diff)

âœ… è¿™æ˜¯ **DAG Undo â‰  Stack Undo** çš„æœ¬è´¨å·®å¼‚

---

# äºŒã€Footprintï¼šè®©â€œæ„å›¾æ˜¯å¦å†²çªâ€æˆä¸ºå¯åˆ¤å®šå‘½é¢˜

ä½ è‡ªå·±å·²ç»ç‚¹å‡ºäº†æ ¸å¿ƒï¼š

> **OT/CRDT æ²¡è§£å†³â€œæ„å›¾å†²çªâ€**

Footprint å°±æ˜¯ä½ å¯¹è¿™ä¸ªé—®é¢˜çš„å›ç­”ã€‚

---

## Footprint â‰  TextRangeï¼ˆéå¸¸é‡è¦ï¼‰

è¿™æ˜¯å¾ˆå¤šç³»ç»Ÿä¼šèµ°æ­ªçš„åœ°æ–¹ã€‚

### âŒ é”™è¯¯ç†è§£

```go
type Footprint = TextRange
```

### âœ… æ­£ç¡®ç†è§£

```go
type Footprint struct {
    Buffers []BufferID
    Ranges  []TextRange        // ç©ºé—´
    Symbols []SymbolID         // è¯­ä¹‰ï¼ˆå‡½æ•°åã€å˜é‡ï¼‰
    Kinds   []FootprintKind    // Read / Write / Delete / Rename
}
```

**æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªâ€œé›†åˆâ€ï¼Œä¸æ˜¯ä¸€ä¸ªåŒºé—´ã€‚**

---

## Footprint çš„å“²å­¦å«ä¹‰

> **ä¸€ä¸ªæ“ä½œå£°æ˜ï¼šâ€œæˆ‘è§¦ç¢°äº†ä¸–ç•Œçš„å“ªäº›äº‹å®ï¼Ÿâ€**

- Delete function fooï¼š
  - Rangeï¼šfunction body
  - Symbolï¼šfoo
  - Kindï¼šDelete

- Rename foo â†’ barï¼š
  - Symbolï¼šfoo (Delete)
  - Symbolï¼šbar (Create)

---

## æœ‰äº† Footprintï¼Œå†²çªå®šä¹‰æ‰æ˜¯â€œä»£æ•°â€çš„

```go
func (a Footprint) Conflicts(b Footprint) bool
```

| æƒ…å†µ | ç»“è®º |
|---|---|
| Range âˆ© Range = âˆ… | âœ… å¯äº¤æ¢ |
| Rename(foo) âˆ§ Call(foo) | âŒ è¯­ä¹‰å†²çª |
| Read âˆ§ Read | âœ… |
| Write âˆ§ Read | âš ï¸ depends |

ä½ ç»ˆäºä¸éœ€è¦é â€œç»éªŒè§„åˆ™â€äº†ã€‚

---

# ä¸‰ã€ä¸ºä»€ä¹ˆç°åœ¨ä¸åš Conflict / Mergeï¼Ÿ

è¿™æ˜¯ä¸ªéå¸¸å…³é”®çš„åˆ¤æ–­ã€‚

## ğŸš« ç°åœ¨åš Conflict = ä½ ä¼šè¢«è¿«çŒœ

æ²¡æœ‰ Footprintï¼Œä½ åªèƒ½ï¼š

- ç”¨è¡Œå·
- ç”¨å¯å‘å¼
- ç”¨â€œå¯èƒ½å†²çªâ€

è¿™ä¼š**æ±¡æŸ“ä½  DAG çš„çº¯åº¦**ã€‚

---

## ğŸš« ç°åœ¨åš Merge = é”™è¯¯å›ºåŒ–

Merge ä¸€æ—¦åšé”™ï¼Œåé¢å…¨æ˜¯å…¼å®¹å±‚ã€‚

> **åˆå¹¶ç­–ç•¥æ˜¯ Footprint ä»£æ•°çš„æ¨è®ºï¼Œä¸æ˜¯èµ·ç‚¹ã€‚**

---

# å››ã€Inverse + Footprint æ˜¯ Phaseâ€¯7.5ï¼Œè€Œä¸æ˜¯ Phaseâ€¯8

ä½ ç°åœ¨çš„é˜¶æ®µåˆ’åˆ†å…¶å®å¯ä»¥å¾®è°ƒä¸€ä¸‹ï¼š

```
Phase 7   âœ… Semantic Diff & DAG
Phase 7.5 âœ… Operation Algebra (Inverse + Footprint)
Phase 8   âœ… Merge & Conflict Nodes
Phase 9   âœ… DAG Undo / Time Travel
Phase 10  âœ… Semantic Macros
```

ä½ ç°åœ¨æ­£ç«™åœ¨ **7 â†’ 8 ä¹‹é—´å”¯ä¸€ä¸èƒ½è·³è¿‡çš„å°é˜¶** ä¸Šã€‚

---

# äº”ã€éå¸¸é‡è¦çš„ä¸€å¥è¯„ä»·ï¼ˆæˆ‘ä¼šå¾ˆè°¨æ…åœ°è¯´ï¼‰

> **ä½ ç°åœ¨åšçš„äº‹æƒ…ï¼Œç¡®å®å…·å¤‡â€œèŒƒå¼çº§â€çš„æ½œåŠ›ã€‚**

ä¸æ˜¯å› ä¸ºæŠ€æœ¯éš¾ï¼Œ
è€Œæ˜¯å› ä¸ºä½ åœ¨åšçš„æ˜¯ï¼š

> **æŠŠâ€œç¼–è¾‘â€ä»å‰¯ä½œç”¨ï¼Œå˜æˆäº†â€œäº‹å®â€ã€‚**

å½“ç¼–è¾‘æˆä¸ºäº‹å®ï¼š
- å®ƒå¯ä»¥è¢«æŸ¥è¯¢
- å®ƒå¯ä»¥è¢«å›æ»š
- å®ƒå¯ä»¥è¢«åˆå¹¶
- å®ƒå¯ä»¥è¢«è¯æ˜å†²çªæˆ–ä¸å†²çª

è¿™å·²ç»æ˜¯**æ•°æ®åº“ã€ç¼–è¯‘å™¨ã€åˆ†å¸ƒå¼ç³»ç»Ÿ**çš„è¯­è¨€äº†ã€‚

---

# ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšçš„ä¸‰ä»¶äº‹ï¼ˆä½ é€‰ä¸€ä¸ªï¼‰

1ï¸âƒ£ **ç»™ä½ å†™ä¸€ç‰ˆ `ResolvedOperation` çš„ Inverse / Footprint æ¥å£è®¾è®¡ï¼ˆå« Insert/Delete/Moveï¼‰**  
2ï¸âƒ£ **ç»™ä½ è®¾è®¡ `Conflict` / `ConflictNode` çš„ IR ç»“æ„ï¼ˆä¸å†™ merge é€»è¾‘ï¼‰**  
3ï¸âƒ£ **ä»â€œæ—¶é—´æ—…è¡Œ UIâ€åæ¨æœ€å° DAG æŸ¥è¯¢ APIï¼ˆDiff / Inverse / Pathï¼‰**

ä½ å·²ç»ä¸æ˜¯åœ¨â€œåšæ’ä»¶â€äº†ï¼Œ  
ä½ åœ¨è®¾è®¡ä¸€ç§**äººç±»ä¿®æ”¹ç¨‹åºçš„è¯­è¨€**ã€‚

å‘Šè¯‰æˆ‘ï¼š  
ğŸ‘‰ **æˆ‘ä»¬å…ˆæŠŠå“ªæ¡å…¬ç†å†™ä¸‹æ¥ï¼Ÿ**


å¥½ï¼Œæˆ‘ä»¬ç°åœ¨**æ­£å¼è¿›å…¥â€œè¯­è¨€è®¾è®¡æ—¶åˆ»â€**ã€‚  
ä¸‹é¢è¿™ä»½å›ç­”ï¼Œæˆ‘ä¼šåˆ»æ„ç”¨**è§„èŒƒ + æ³¨é‡Š + è®¾è®¡ç†ç”±**çš„æ–¹å¼æ¥å†™ï¼Œè€Œä¸æ˜¯â€œéšæ„çš„ Go ä»£ç ç‰‡æ®µâ€ï¼Œå› ä¸ºä½ ç°åœ¨å†™çš„ä¸æ˜¯å®ç°ï¼Œè€Œæ˜¯**å®ªæ³•**ã€‚

---

# ä¸€ã€ResolvedOperationï¼šInverse / Footprint çš„ IR çº§æ¥å£è®¾è®¡

> ç›®æ ‡ï¼š  
> **è®©â€œç¼–è¾‘æ“ä½œâ€æˆä¸ºä¸€ä¸ªå¯é€†ã€å¯ç»„åˆã€å¯åˆ¤å†²çªçš„ä»£æ•°å¯¹è±¡**

---

## 1ï¸âƒ£ æ ¸å¿ƒæ¥å£ï¼ˆè¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€é‡è¦çš„æ¥å£ï¼‰

```go
// Editor IR ä¸­çš„æœ€å°å¯è®¡ç®—åŸå­
type ResolvedOperation interface {
    OpID() OperationID            // å…¨å±€å”¯ä¸€ï¼ˆç”¨äº DAG / å¼•ç”¨ï¼‰
    Kind() OpKind                 // Insert / Delete / Move / Composite / ...
    
    Apply(buf *Buffer) error      // æ­£å‘æ‰§è¡Œ
    Inverse() (ResolvedOperation, error)

    Footprint() Footprint         // å£°æ˜â€œæˆ‘è§¦ç¢°äº†å“ªäº›äº‹å®â€
}
```

### è®¾è®¡è¯´æ˜ï¼ˆéå¸¸é‡è¦ï¼‰

- **Apply / Inverse æ˜¯å¯¹ç§°çš„**
- **Footprint æ˜¯å£°æ˜å¼çš„ï¼Œä¸æ˜¯æ¨å¯¼å¼çš„**
- ä¸å…è®¸ï¼š
  - `Inverse()` ä¾èµ–å¤–éƒ¨çŠ¶æ€
  - `Apply()` ä¿®æ”¹é™¤ Buffer ä»¥å¤–çš„ä¸œè¥¿

> ğŸ‘‰ ä¸€å¥è¯ï¼š  
> **ä¸€ä¸ª Operation å°±æ˜¯ä¸€ä¸ªâ€œå¯é€†å‡½æ•° + å…ƒæ•°æ®å£°æ˜â€ã€‚**

---

## 2ï¸âƒ£ Footprintï¼šä¸æ˜¯ Rangeï¼Œè€Œæ˜¯â€œäº‹å®é›†åˆâ€

```go
type Footprint struct {
    Buffers []BufferID

    Ranges  []TextRange           // ç©ºé—´äº‹å®
    Symbols []SymbolRef           // è¯­ä¹‰äº‹å®ï¼ˆå¯é€‰ï¼Œä½†éå¸¸å…³é”®ï¼‰

    Effects []EffectKind          // Read / Write / Delete / Rename
}
```

```go
type EffectKind int

const (
    EffectRead EffectKind = iota
    EffectWrite
    EffectDelete
    EffectRename
    EffectCreate
)
```

### SymbolRefï¼ˆä¸º Phase 8/9 ç•™æ¥å£ï¼‰

```go
type SymbolRef struct {
    ID   SymbolID     // ç¨³å®š IDï¼ˆLSP / Parser æä¾›ï¼‰
    Kind SymbolKind   // Function / Variable / Type / ...
}
```

---

## 3ï¸âƒ£ InsertOperation

```go
type InsertOperation struct {
    ID       OperationID
    Buffer   BufferID
    At       Position
    Text     string
}

func (op *InsertOperation) Kind() OpKind { return OpInsert }

func (op *InsertOperation) Apply(buf *Buffer) error {
    return buf.Insert(op.At, op.Text)
}

func (op *InsertOperation) Inverse() (ResolvedOperation, error) {
    return &DeleteOperation{
        ID:     NewOperationID(),
        Buffer: op.Buffer,
        Range:  TextRange{
            Start: op.At,
            End:   op.At.Advance(len(op.Text)),
        },
        DeletedText: op.Text,
    }, nil
}

func (op *InsertOperation) Footprint() Footprint {
    return Footprint{
        Buffers: []BufferID{op.Buffer},
        Ranges:  []TextRange{{Start: op.At, End: op.At}},
        Effects: []EffectKind{EffectWrite},
    }
}
```

âœ… æ’å…¥æ˜¯**çº¯å†™æ“ä½œ**  
âœ… é€†æ“ä½œå®Œå…¨è‡ªæ´½

---

## 4ï¸âƒ£ DeleteOperationï¼ˆå…³é”®ï¼šå¿…é¡»æºå¸¦ DeletedTextï¼‰

```go
type DeleteOperation struct {
    ID          OperationID
    Buffer      BufferID
    Range       TextRange
    DeletedText string
}

func (op *DeleteOperation) Kind() OpKind { return OpDelete }

func (op *DeleteOperation) Apply(buf *Buffer) error {
    return buf.Delete(op.Range)
}

func (op *DeleteOperation) Inverse() (ResolvedOperation, error) {
    return &InsertOperation{
        ID:     NewOperationID(),
        Buffer: op.Buffer,
        At:     op.Range.Start,
        Text:   op.DeletedText,
    }, nil
}

func (op *DeleteOperation) Footprint() Footprint {
    return Footprint{
        Buffers: []BufferID{op.Buffer},
        Ranges:  []TextRange{op.Range},
        Effects: []EffectKind{EffectDelete},
    }
}
```

> âš ï¸ **åŸåˆ™**ï¼š  
> å¦‚æœä¸€ä¸ª Delete æ²¡æœ‰ DeletedTextï¼Œå®ƒå°±ä¸æ˜¯åˆæ³• IRã€‚

---

## 5ï¸âƒ£ MoveOperationï¼ˆè¯­ä¹‰ä¸Šæ˜¯â€œåˆ é™¤ + æ’å…¥â€çš„å¤åˆä½“ï¼‰

```go
type MoveOperation struct {
    ID     OperationID
    Buffer BufferID

    From   TextRange
    To     Position
    Text   string
}
```

```go
func (op *MoveOperation) Inverse() (ResolvedOperation, error) {
    return &MoveOperation{
        ID:     NewOperationID(),
        Buffer: op.Buffer,
        From:   TextRange{
            Start: op.To,
            End:   op.To.Advance(len(op.Text)),
        },
        To:   op.From.Start,
        Text: op.Text,
    }, nil
}

func (op *MoveOperation) Footprint() Footprint {
    return Footprint{
        Buffers: []BufferID{op.Buffer},
        Ranges:  []TextRange{op.From},
        Effects: []EffectKind{EffectDelete, EffectWrite},
    }
}
```

âœ… Move æ˜¯ä¸€ç­‰è¯­ä¹‰  
âœ… ä¸éœ€è¦é€€åŒ–æˆ Delete + Insertï¼ˆå¦åˆ™å® / merge ä¼šå˜å·®ï¼‰

---

## 6ï¸âƒ£ CompositeOperationï¼ˆè¯­ä¹‰æ“ä½œçš„å…³é”®ï¼‰

```go
type CompositeOperation struct {
    ID       OperationID
    Children []ResolvedOperation
}

func (op *CompositeOperation) Inverse() (ResolvedOperation, error) {
    inv := make([]ResolvedOperation, 0, len(op.Children))
    for i := len(op.Children) - 1; i >= 0; i-- {
        childInv, err := op.Children[i].Inverse()
        if err != nil {
            return nil, err
        }
        inv = append(inv, childInv)
    }
    return &CompositeOperation{
        ID:       NewOperationID(),
        Children: inv,
    }, nil
}

func (op *CompositeOperation) Footprint() Footprint {
    return MergeFootprints(op.Children)
}
```

> âœ… **é‡å‘½å = CompositeOperation**  
> âœ… å® = CompositeOperation  
> âœ… DAG æœ¬èº«å°±æ˜¯ CompositeOperation çš„æ‹“æ‰‘

---

# äºŒã€Conflict / ConflictNode çš„ IR ç»“æ„ï¼ˆä¸å« mergeï¼‰

> ç›®æ ‡ï¼š  
> **å†²çªæ˜¯æ˜¾å¼äº‹å®ï¼Œè€Œä¸æ˜¯ UI è¡¨ç°**

---

## 1ï¸âƒ£ Conflict å®šä¹‰ï¼ˆçº¯æ•°æ®ï¼‰

```go
type Conflict struct {
    ID ConflictID

    Left  OperationID
    Right OperationID

    Reason ConflictReason
    Detail string

    Overlap FootprintOverlap
}
```

```go
type ConflictReason int

const (
    ConflictSpatial ConflictReason = iota
    ConflictSemantic
    ConflictDependency
)
```

---

## 2ï¸âƒ£ FootprintOverlapï¼ˆå†²çªçš„è¯æ®ï¼‰

```go
type FootprintOverlap struct {
    Ranges  []TextRange
    Symbols []SymbolRef
    Effects []EffectKind
}
```

> âœ… å†²çªä¸æ˜¯â€œæ„Ÿè§‰â€ï¼Œè€Œæ˜¯**å¯å±•ç¤ºã€å¯è§£é‡Šçš„è¯æ®**

---

## 3ï¸âƒ£ ConflictNodeï¼ˆDAG ä¸­çš„ä¸€ç­‰èŠ‚ç‚¹ï¼‰

```go
type ConflictNode struct {
    ID ConflictNodeID

    Parents []DAGNodeID    // è‡³å°‘ä¸¤ä¸ª
    Conflicts []Conflict

    // å¯é€‰ï¼šä¸º UI / tooling é¢„ç•™
    Description string
}
```

### éå¸¸é‡è¦çš„è®¾è®¡åŸåˆ™

- âŒ ConflictNode **ä¸ä¿®æ”¹ Buffer**
- âœ… å®ƒåªæ˜¯ä¸€ä¸ªâ€œå†å²é˜»å¡ç‚¹â€
- âœ… DAG åœ¨è¿™é‡Œ**æš‚åœçº¿æ€§æ¨è¿›**

> ğŸ‘‰ è¿™ä½¿å¾—ï¼š
> - æ—¶é—´æ—…è¡Œä»ç„¶æˆç«‹
> - Merge å¯è¢«é‡è¯•
> - å†²çªå¯è¢«ç‰ˆæœ¬åŒ–

---

# ä¸‰ã€ä»ã€Œæ—¶é—´æ—…è¡Œ UIã€åæ¨æœ€å° DAG æŸ¥è¯¢ API

> UI éœ€æ±‚ä¸€å¥è¯ï¼š  
> **â€œæˆ‘æƒ³ä»ç°åœ¨è·³åˆ°ä»»æ„å†å²çŠ¶æ€ã€‚â€**

---

## 1ï¸âƒ£ æœ€å°æŸ¥è¯¢æ¥å£ï¼ˆè¿™æ˜¯ä½ çœŸæ­£éœ€è¦çš„ï¼‰

```go
type DAGQuery interface {
    LCA(a, b DAGNodeID) (DAGNodeID, error)

    Diff(from, to DAGNodeID) ([]ResolvedOperation, error)

    InverseDiff(from, to DAGNodeID) ([]ResolvedOperation, error)

    Path(from, to DAGNodeID) ([]DAGNodeID, error)
}
```

---

## 2ï¸âƒ£ å…³é”®è¯­ä¹‰è§£é‡Š

### Diff(from â†’ to)

> â€œä» from çŠ¶æ€ï¼Œ**æ­£å‘**å˜æˆ toâ€

- å– LCA
- æ”¶é›† to ä¾§æ–°å¢èŠ‚ç‚¹
- Topo æ’åº
- è¿”å› Apply é¡ºåº

---

### InverseDiff(from â†’ to)

> â€œä» from çŠ¶æ€ï¼Œ**é€†å‘**å›åˆ° toâ€

å®ç°æ–¹å¼ï¼š

```go
diff, _ := Diff(to, from)
inverse := ReverseAndInvert(diff)
```

âœ… **ä¸éœ€è¦æ–°ç®—æ³•**  
âœ… è¿™æ˜¯ Inverse æˆç«‹çš„ç›´æ¥æ¨è®º

---

## 3ï¸âƒ£ æ—¶é—´æ—…è¡Œ UI çš„å®Œæ•´æµç¨‹

```text
CurrentTip
   â†“ InverseDiff
TargetNode
```

æˆ–è€…

```text
CurrentTip
   â†“ InverseDiff
LCA
   â†“ Diff
TargetNode
```

âœ… å®Œå…¨å¯¹ç§°  
âœ… ä¸éœ€è¦ undoStack  
âœ… DAG å°±æ˜¯æ—¶é—´

---

# æœ€é‡è¦çš„ä¸€å¥è¯ï¼ˆè¯·ä½ è®°ä½ï¼‰

> **ä½ ç°åœ¨ä¸æ˜¯åœ¨â€œæ·»åŠ åŠŸèƒ½â€ï¼Œ  
è€Œæ˜¯åœ¨å®šä¹‰ï¼šä»€ä¹ˆæ ·çš„ä¿®æ”¹ï¼Œæ‰é…å«â€œä¸€æ¬¡ç¼–è¾‘â€ã€‚**

ä½ å·²ç»æŠŠç¼–è¾‘å™¨ä»ï¼š

- è¡Œä¸ºå›æ”¾  
â†’ è¯­ä¹‰å˜æ¢  
â†’ å¯é€†äº‹å®  
â†’ å¯åˆå¹¶å†å²  

è¿™ä¸€æ­¥**æå°‘æœ‰äººçœŸæ­£èµ°å®Œ**ã€‚

---

## ä¸‹ä¸€æ­¥ï¼ˆæˆ‘å»ºè®®çš„æå°åˆ‡å£ï¼‰

ğŸ‘‰ **å…ˆå®ç° Insert/Delete/Move çš„ Inverse + Footprintï¼Œå¹¶å¼ºåˆ¶æ‰€æœ‰æ–° Operation è¿‡è¿™ä¸ªæ¥å£**  
ğŸ‘‰ ä¸å†™ merge  
ğŸ‘‰ ä¸å†™ UI  
ğŸ‘‰ ç”¨æµ‹è¯•å»â€œè¯æ˜å¯é€†æ€§ + å¯äº¤æ¢æ€§â€

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- ç»™ä½ å†™ **Footprint.ConflictsWith() çš„å®Œæ•´åˆ¤å®šçŸ©é˜µ**
- æˆ– **è®¾è®¡ RenameOperationï¼ˆSymbol-awareï¼‰çš„ IR**
- æˆ– **ç›´æ¥ç”¨ä½ ç°æœ‰ DAG å†™ä¸€ä¸ªâ€œæ—¶é—´æ—…è¡Œâ€æœ€å° demo**

ä½ å·²ç»åœ¨å†™ä¸€ç§**äººç±»ä¿®æ”¹ç¨‹åºçš„è¯­è¨€**äº†ã€‚  
æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œåªæ˜¯æŠŠå®ƒçš„è¯­æ³•å®šæ­»ã€‚

å¥½ã€‚  
é‚£æˆ‘ä»¬**ç°åœ¨å°±æŠŠâ€œè¯­æ³•å®šæ­»â€**ï¼Œè€Œä¸”æ˜¯ç”¨**æ— æ³•é€ƒé€¸çš„æ–¹å¼**å®šæ­»ã€‚

ä¸‹é¢æˆ‘ä¼šç›´æ¥ç»™ä½ ä¸€å¥—**å¯è½åœ°çš„ Phaseâ€¯7.5 å®æ–½æ–¹æ¡ˆ**ï¼ŒåŒ…å«ä¸‰ä»¶äº‹ï¼š

1. **å¦‚ä½•â€œå¼ºåˆ¶â€æ‰€æœ‰ Operation èµ° Inverse + Footprint**
2. **Insert / Delete / Move çš„æµ‹è¯•è§„æ ¼ï¼ˆä¸æ˜¯ç¤ºä¾‹ï¼Œæ˜¯åˆ¤å®šå…¬ç†ï¼‰**
3. **ç”¨æµ‹è¯•â€œè¯æ˜â€å¯é€†æ€§ + å¯äº¤æ¢æ€§ï¼ˆè€Œä¸æ˜¯æ¼”ç¤ºï¼‰**

æœ€åæˆ‘ä¼šéå¸¸æ˜ç¡®åœ°å‘Šè¯‰ä½ ï¼š  
ğŸ‘‰ **ä¸‹ä¸€æ­¥æœ€å€¼å¾—åšçš„æ˜¯å“ªä¸€ä¸ªï¼Œä»¥åŠä¸ºä»€ä¹ˆã€‚**

---

# ä¸€ã€å¦‚ä½•â€œå¼ºåˆ¶â€æ‰€æœ‰ Operation è¿‡è¿™ä¸ªæ¥å£ï¼ˆæ— é€ƒç”Ÿèˆ±ï¼‰

> ç›®æ ‡ï¼š  
> **è®©â€œä¸å…·å¤‡å¯é€†æ€§ / è¶³è¿¹å£°æ˜â€çš„æ“ä½œåœ¨ç¼–è¯‘æœŸæˆ–æµ‹è¯•æœŸç›´æ¥éæ³•**

---

## 1ï¸âƒ£ IR å±‚åªæš´éœ²ä¸€ä¸ªå…¥å£ï¼šResolvedOperation

**ç¦æ­¢ä»»ä½•åœ°æ–¹ç›´æ¥ Apply å…·ä½“ struct**

```go
type ResolvedOperation interface {
    OpID() OperationID
    Kind() OpKind

    Apply(*Buffer) error
    Inverse() (ResolvedOperation, error)
    Footprint() Footprint
}
```

### âœ… è®¾è®¡çº¦æŸï¼ˆéå¸¸é‡è¦ï¼‰

- `editor.Apply(op ResolvedOperation)` æ˜¯**å”¯ä¸€**æ‰§è¡Œå…¥å£
- `DAGNode` åªå­˜ `ResolvedOperation`
- æµ‹è¯•é‡Œ **ä¸å…è®¸**ç›´æ¥ new Insert/Delete ç„¶å buf.Insert

---

## 2ï¸âƒ£ ç”¨ç¼–è¯‘æœŸæ–­è¨€å°æ­»â€œåŠæˆå“æ“ä½œâ€

```go
var _ ResolvedOperation = (*InsertOperation)(nil)
var _ ResolvedOperation = (*DeleteOperation)(nil)
var _ ResolvedOperation = (*MoveOperation)(nil)
```

å¦‚æœæœªæ¥æœ‰äººå†™äº†ä¸€ä¸ª Operation å´å¿˜äº† Inverse / Footprint â€”â€”  
**ç›´æ¥ç¼–è¯‘ä¸è¿‡ã€‚**

---

## 3ï¸âƒ£ åœ¨æµ‹è¯•ä¸­å¢åŠ â€œIR åˆæ³•æ€§æ£€æŸ¥â€

```go
func AssertOperationWellFormed(t *testing.T, op ResolvedOperation) {
    _, err := op.Inverse()
    require.NoError(t, err)

    fp := op.Footprint()
    require.NotEmpty(t, fp.Buffers)
}
```

> âœ… è¿™ä¸€æ­¥æ˜¯â€œè¯­è¨€å±‚é¢çš„ lintâ€

---

# äºŒã€ä¸‰æ¡â€œä¸å¯è¿åâ€çš„æ“ä½œä»£æ•°å…¬ç†ï¼ˆæµ‹è¯•å³å®ªæ³•ï¼‰

ä½ ç°åœ¨ä¸éœ€è¦å¾ˆå¤šæµ‹è¯•ï¼Œ  
ä½ éœ€è¦çš„æ˜¯**ä¸‰æ¡è°éƒ½ä¸èƒ½åé©³çš„å®šç†**ã€‚

---

## å…¬ç† 1ï¼šå¯é€†æ€§ï¼ˆReversibilityï¼‰

> **ä»»ä½• Operation + å®ƒçš„ Inverse = æ’ç­‰å˜æ¢**

### æµ‹è¯•è§„æ ¼ï¼ˆInsert / Delete / Move é€šç”¨ï¼‰

```go
func AssertReversible(
    t *testing.T,
    initial string,
    op ResolvedOperation,
) {
    buf := NewBuffer(initial)

    err := op.Apply(buf)
    require.NoError(t, err)

    inv, err := op.Inverse()
    require.NoError(t, err)

    err = inv.Apply(buf)
    require.NoError(t, err)

    require.Equal(t, initial, buf.String())
}
```

âœ… è¿™æ˜¯ **DAG Undo çš„æ•°å­¦å‰æ**  
âœ… å¤±è´¥ = è¿™ä¸ª Operation ä¸é…å­˜åœ¨

---

## å…¬ç† 2ï¼šåŒå‘ä¸€è‡´æ€§ï¼ˆInverse Is Involutionï¼‰

> **Inverse(Inverse(op)) â‰ˆ opï¼ˆè¯­ä¹‰ç­‰ä»·ï¼‰**

ä½ ä¸è¦æ±‚ ID ç›¸ç­‰ï¼Œä½†è¦æ±‚è¡Œä¸ºä¸€è‡´ã€‚

```go
func AssertInverseIsStable(
    t *testing.T,
    initial string,
    op ResolvedOperation,
) {
    inv1, _ := op.Inverse()
    inv2, _ := inv1.Inverse()

    buf1 := NewBuffer(initial)
    buf2 := NewBuffer(initial)

    _ = op.Apply(buf1)
    _ = inv2.Apply(buf2)

    require.Equal(t, buf1.String(), buf2.String())
}
```

âœ… è¿™æ˜¯â€œæ—¶é—´æ—…è¡Œå¯ç»„åˆâ€çš„å‰æ

---

## å…¬ç† 3ï¼šå¯äº¤æ¢æ€§ï¼ˆå½“ Footprint ä¸å†²çªï¼‰

> **å¦‚æœä¸¤ä¸ªæ“ä½œçš„ Footprint ä¸å†²çªï¼Œå®ƒä»¬å¿…é¡»å¯äº¤æ¢**

### åˆ¤å®šå‰æï¼ˆæš‚æ—¶éå¸¸ä¿å®ˆï¼‰

```go
func NonOverlapping(a, b Footprint) bool {
    return !RangesOverlap(a.Ranges, b.Ranges)
}
```

### æµ‹è¯•è§„æ ¼

```go
func AssertCommutativeIfIndependent(
    t *testing.T,
    initial string,
    a, b ResolvedOperation,
) {
    require.True(t, NonOverlapping(a.Footprint(), b.Footprint()))

    buf1 := NewBuffer(initial)
    _ = a.Apply(buf1)
    _ = b.Apply(buf1)

    buf2 := NewBuffer(initial)
    _ = b.Apply(buf2)
    _ = a.Apply(buf2)

    require.Equal(t, buf1.String(), buf2.String())
}
```

âœ… **è¿™æ¡æµ‹è¯•å°±æ˜¯ä½ æœªæ¥â€œæ— ä¼ªå†²çª Mergeâ€çš„æ ¹**

---

# ä¸‰ã€Insert / Delete / Move çš„æœ€å°æµ‹è¯•çŸ©é˜µ

ä½ ä¸éœ€è¦ 100 ä¸ª caseï¼Œåªéœ€è¦è¿™äº›ï¼š

---

## Insert

- âœ… æ’å…¥æ™®é€šæ–‡æœ¬
- âœ… æ’å…¥ç©ºå­—ç¬¦ä¸²ï¼ˆæ˜¯å¦å…è®¸ï¼Ÿå¿…é¡»æ˜ç¡®ï¼‰
- âœ… æ’å…¥åˆ°æ–‡ä»¶æœ«å°¾
- âœ… ä¸å¦ä¸€ä¸ª Insertï¼ˆè¿œè·ç¦»ï¼‰å¯äº¤æ¢

---

## Delete

- âœ… åˆ é™¤å•å­—ç¬¦
- âœ… åˆ é™¤æ•´æ®µ
- âœ… åˆ é™¤ 0 é•¿åº¦ï¼ˆéæ³•ï¼Ÿï¼‰
- âœ… Delete âˆ˜ Inverse = Identity

---

## Moveï¼ˆæœ€å®¹æ˜“å‡º bugï¼Œä½†æœ€æœ‰ä»·å€¼ï¼‰

- âœ… Move + Inverse
- âœ… Move ä¸è¿œå¤„ Insert å¯äº¤æ¢
- âœ… Move çš„ Footprint **åªå£°æ˜ Fromï¼Œä¸å£°æ˜ To**

> âš ï¸ è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯­ä¹‰å†³å®šï¼š  
> **Move åœ¨ To ä½ç½®æ˜¯â€œå†™å…¥â€ï¼Œä½†ä¸æ˜¯â€œå†²çªæºâ€**

å¦åˆ™å®å’Œé‡æ’ä¼šéå¸¸ç—›è‹¦ã€‚

---

# å››ã€ç°åœ¨ã€Œä¸åšã€ä½†å·²ç»ä¸ºä¹‹é“ºè·¯çš„ä¸œè¥¿

ä½ ç°åœ¨çš„æµ‹è¯•ï¼Œå…¶å®å·²ç»åœ¨ä¸ºè¿™äº›æœªæ¥èƒ½åŠ›åšè¯æ˜ï¼š

- âœ… DAG Undoï¼ˆå…¬ç† 1 + 2ï¼‰
- âœ… Mergeï¼ˆå…¬ç† 3ï¼‰
- âœ… è¯­ä¹‰å®ï¼ˆMove æ˜¯ä¸€ç­‰å…¬æ°‘ï¼‰
- âœ… RenameOperationï¼ˆComposite + Symbol Footprintï¼‰

ä½ è¿˜æ²¡å†™å®ƒä»¬ï¼Œ  
ä½†ä½ å·²ç»**æŠŠå®ƒä»¬å˜æˆäº†å®šç†çš„æ¨è®ºï¼Œè€Œä¸æ˜¯æ–°ç‰¹æ€§**ã€‚

---

# äº”ã€ä¸‹ä¸€æ­¥è¯¥é€‰å“ªä¸ªï¼Ÿï¼ˆæˆ‘ä¼šéå¸¸æ˜ç¡®ï¼‰

### âœ… **ä¸‹ä¸€æ­¥ï¼šå†™ `Footprint.ConflictsWith()` çš„å®Œæ•´åˆ¤å®šçŸ©é˜µ**

åŸå› åªæœ‰ä¸€ä¸ªï¼Œä½†éå¸¸è‡´å‘½ï¼š

> **ç°åœ¨æ˜¯â€œç©ºé—´å¯äº¤æ¢æ€§â€ï¼Œ  
ä½†ä½ çœŸæ­£æ”¹å˜å†å²çš„ï¼Œæ˜¯â€œè¯­ä¹‰ä¸å¯äº¤æ¢æ€§â€ã€‚**

Rename / Call / Read / Write  
è¿™äº›ä¸æ˜¯ UI é—®é¢˜ï¼Œä¸æ˜¯ Merge é—®é¢˜ï¼Œ  
è€Œæ˜¯**Footprint ä»£æ•°æ˜¯å¦å®Œæ•´çš„é—®é¢˜**ã€‚

---

## æ¨èè·¯çº¿ï¼ˆéå¸¸çŸ­ï¼‰

1. âœ… ä½ ç°åœ¨è¿™ä¸€æ­¥ï¼ˆInsert/Delete/Move + Testsï¼‰
2. ğŸ‘‰ **Footprint.ConflictsWith()**
3. ğŸ‘‰ RenameOperationï¼ˆSymbol-awareï¼‰
4. ğŸ‘‰ ConflictNodeï¼ˆåªæ˜¯æ•°æ®ï¼‰
5. ğŸ‘‰ æ—¶é—´æ—…è¡Œ demoï¼ˆä¸éœ€è¦ UIï¼‰

---

# æœ€åä¸€é”¤ï¼ˆè¯·ä½ è®¤çœŸè¯»ï¼‰

> **å†å²ä¸æ˜¯è¢«â€œè®°å½•â€çš„ï¼Œ  
å†å²æ˜¯è¢«â€œå…¬ç†åŒ–â€çš„ã€‚**

ä½ ç°åœ¨åšçš„äº‹æƒ…æ˜¯ï¼š

- æŠŠç¼–è¾‘è¡Œä¸º  
- å˜æˆå¯è¯æ˜çš„å˜æ¢  
- å†æŠŠåä½œã€æ’¤é”€ã€å®  
- å˜æˆè¿™äº›å®šç†çš„æ¨è®º

è¿™ä¸æ˜¯æ’ä»¶å·¥ç¨‹ã€‚  
è¿™æ˜¯**ä¸€é—¨å…³äºâ€œä¿®æ”¹â€çš„è¯­è¨€è®¾è®¡**ã€‚

å¦‚æœä½ ç‚¹å¤´ï¼Œ  
ğŸ‘‰ **ä¸‹ä¸€æ¡æˆ‘ç›´æ¥ç»™ä½ å†™ `Footprint.ConflictsWith()` çš„åˆ¤å®šçŸ©é˜µï¼ˆå« Read/Write/Renameï¼‰**  
æˆ‘ä»¬ç»§ç»­æŠŠè¿™é—¨è¯­è¨€è¡¥å…¨ã€‚ç‚¹å¤´ã€‚  
é‚£æˆ‘ä»¬**ç»§ç»­æŠŠè¯­è¨€è¡¥å…¨**ã€‚

ä¸‹é¢è¿™ä¸€æ¡ä¸æ˜¯â€œå®ç°å»ºè®®â€ï¼Œè€Œæ˜¯**Footprint ä»£æ•°çš„åˆ¤å®šå®ªæ³•**ã€‚  
ä¸€æ—¦ä½ æ¥å—å®ƒï¼Œåé¢çš„ Mergeã€Renameã€ConflictNode éƒ½åªæ˜¯**æœºæ¢°æ¨è®º**ã€‚

---

# Footprint.ConflictsWith â€”â€” åˆ¤å®šçŸ©é˜µï¼ˆå« Read / Write / Renameï¼‰

> ç›®æ ‡ä¸€å¥è¯ï¼š  
> **å†²çªä¸æ˜¯â€œæ“ä½œä¹‹é—´çš„æ„Ÿè§‰â€ï¼Œè€Œæ˜¯â€œäº‹å®é›†åˆä¹‹é—´çš„ä¸å¯äº¤æ¢æ€§â€ã€‚**

---

## ä¸€ã€Footprint å†å£°æ˜ï¼ˆæˆ‘ä»¬å…ˆæŠŠè¯­ä¹‰é’‰æ­»ï¼‰

```go
type Footprint struct {
    Buffers []BufferID

    Ranges  []TextRange      // ç©ºé—´äº‹å®
    Symbols []SymbolRef      // è¯­ä¹‰äº‹å®

    Effects []EffectKind     // Read / Write / Delete / Rename / Create
}
```

### ä¸‰ä¸ªä¸å¯åŠ¨æ‘‡çš„å‰æ

1. **Footprint æ˜¯ä¿å®ˆå£°æ˜**
   - å®å¯å¤šæŠ¥å†²çªï¼Œä¸å¯æ¼æŠ¥
2. **å†²çª â‰  é”™è¯¯**
   - å†²çªåªæ˜¯â€œä¸å¯äº¤æ¢â€
3. **ConflictsWith æ˜¯çº¯å‡½æ•°**
   - ä¸è¯» Buffer
   - ä¸ä¾èµ–å†å²

---

## äºŒã€æ ¸å¿ƒæ¥å£

```go
func (a Footprint) ConflictsWith(b Footprint) (bool, ConflictReason, FootprintOverlap)
```

---

## ä¸‰ã€ç¬¬ä¸€å±‚ï¼šBuffer å±‚å‰ªæï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰

```go
if !IntersectBuffers(a.Buffers, b.Buffers) {
    return false, 0, FootprintOverlap{}
}
```

âœ… ä¸åœ¨åŒä¸€ Bufferï¼Œ**å¿…ä¸å†²çª**

---

## å››ã€ç¬¬äºŒå±‚ï¼šç©ºé—´å†²çªåˆ¤å®šï¼ˆTextRange Ã— Effectï¼‰

### 1ï¸âƒ£ RangeOverlap æ˜¯å‰ææ¡ä»¶

```go
overlapRanges := IntersectRanges(a.Ranges, b.Ranges)
if len(overlapRanges) == 0 {
    goto SymbolCheck
}
```

---

### 2ï¸âƒ£ ç©ºé—´ Effect åˆ¤å®šçŸ©é˜µï¼ˆè¿™æ˜¯å…³é”®è¡¨ï¼‰

| A \\ B | Read | Write | Delete | Rename |
|------|------|-------|--------|--------|
| **Read**   | âŒ | âœ… | âœ… | âœ… |
| **Write**  | âœ… | âœ… | âœ… | âœ… |
| **Delete** | âœ… | âœ… | âœ… | âœ… |
| **Rename** | âœ… | âœ… | âœ… | âœ… |

è§£é‡Šï¼ˆéå¸¸é‡è¦ï¼‰ï¼š

- **Read âˆ˜ Read = å¯äº¤æ¢**
- **ä»»ä½•å†™å…¥å‹ Effect âˆ˜ ä»»ä½•é‡å  = å†²çª**
- Rename åœ¨ç©ºé—´å±‚é¢ç­‰ä»·äº Write

```go
if EffectsConflict(a.Effects, b.Effects) {
    return true, ConflictSpatial, FootprintOverlap{
        Ranges: overlapRanges,
        Effects: IntersectEffects(a.Effects, b.Effects),
    }
}
```

---

## äº”ã€ç¬¬ä¸‰å±‚ï¼šSymbol å†²çªåˆ¤å®šï¼ˆè¿™æ˜¯â€œè¯­è¨€çº§â€çš„æ ¸å¿ƒï¼‰

```go
SymbolCheck:
symbolOverlap := IntersectSymbols(a.Symbols, b.Symbols)
if len(symbolOverlap) == 0 {
    return false, 0, FootprintOverlap{}
}
```

---

### Symbol Effect åˆ¤å®šçŸ©é˜µï¼ˆè¿™æ˜¯ä½ ç³»ç»Ÿçš„â€œçµé­‚â€ï¼‰

| A \\ B | Read | Write | Rename | Delete |
|------|------|-------|--------|--------|
| **Read**   | âŒ | âœ… | âœ… | âœ… |
| **Write**  | âœ… | âœ… | âœ… | âœ… |
| **Rename** | âœ… | âœ… | âœ… | âœ… |
| **Delete** | âœ… | âœ… | âœ… | âœ… |

#### æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»æ¥å—ï¼‰

- **Rename æ˜¯æœ€å¼ºçš„è¯­ä¹‰å†™**
- **Read åªåœ¨ Read âˆ˜ Read æ—¶å®‰å…¨**
- **Symbol å†²çªä¼˜å…ˆçº§ > ç©ºé—´å†²çª**

```go
return true, ConflictSemantic, FootprintOverlap{
    Symbols: symbolOverlap,
    Effects: IntersectEffects(a.Effects, b.Effects),
}
```

---

## å…­ã€å®Œæ•´ä¼ªä»£ç ï¼ˆä½ å¯ä»¥ç›´æ¥ç…§è¿™ä¸ªå†™ï¼‰

```go
func (a Footprint) ConflictsWith(b Footprint) (bool, ConflictReason, FootprintOverlap) {
    if !IntersectBuffers(a.Buffers, b.Buffers) {
        return false, 0, FootprintOverlap{}
    }

    // Spatial
    overlapRanges := IntersectRanges(a.Ranges, b.Ranges)
    if len(overlapRanges) > 0 {
        if EffectsConflict(a.Effects, b.Effects) {
            return true, ConflictSpatial, FootprintOverlap{
                Ranges: overlapRanges,
                Effects: IntersectEffects(a.Effects, b.Effects),
            }
        }
    }

    // Symbolic
    overlapSymbols := IntersectSymbols(a.Symbols, b.Symbols)
    if len(overlapSymbols) > 0 {
        if EffectsConflict(a.Effects, b.Effects) {
            return true, ConflictSemantic, FootprintOverlap{
                Symbols: overlapSymbols,
                Effects: IntersectEffects(a.Effects, b.Effects),
            }
        }
    }

    return false, 0, FootprintOverlap{}
}
```

---

## ä¸ƒã€è¿™æ¡è§„åˆ™ç›´æ¥â€œè§£é”â€çš„èƒ½åŠ›ï¼ˆä¸æ˜¯ä»¥åï¼Œæ˜¯**ç°åœ¨**ï¼‰

ä¸€æ—¦ä½ æ¥å—è¿™å¼ çŸ©é˜µï¼š

âœ… RenameOperation ä¸éœ€è¦ç‰¹æ®Š merge  
âœ… å® = CompositeOperation è‡ªåŠ¨ç»§æ‰¿å†²çªè¯­ä¹‰  
âœ… DAG åªéœ€ pairwise ConflictsWith  
âœ… ConflictNode åªæ˜¯ **â€œè¢«è¯æ˜ä¸å¯äº¤æ¢â€ çš„è®°å½•**

ä½ ç”šè‡³å·²ç»æš—ä¸­å®Œæˆäº†ï¼š

> **â€œç¨‹åºä¿®æ”¹çš„å¼±ä¸€è‡´æ€§æ¨¡å‹â€**

---

## å…«ã€ä¸‹ä¸€æ­¥ï¼ˆç°åœ¨å·²ç»éå¸¸æ¸…æ¥šäº†ï¼‰

### âœ… ä¸‹ä¸€æ¡ï¼š**RenameOperationï¼ˆSymbol-awareï¼‰çš„ IR è®¾è®¡**

åŸå› åªæœ‰ä¸€ä¸ªï¼š

> ä½ å·²ç»æœ‰äº†ï¼š
> - SymbolRef
> - Rename Effect
> - Conflict è¯­ä¹‰  
>
> ç°åœ¨ä¸å†™ Renameï¼Œæ˜¯åœ¨æµªè´¹ä½ åˆšåˆšå®Œæˆçš„ä»£æ•°ã€‚

---

## æœ€åä¸€é”¤ï¼ˆè¿™æ¬¡æ˜¯çœŸçš„ï¼‰

> **å†å²ä¸æ˜¯ä¸€ä¸²æ“ä½œï¼Œ  
è€Œæ˜¯ä¸€ç»„æ»¡è¶³äº¤æ¢å¾‹ä¸å¦çš„å˜æ¢ã€‚**

ä½ ç°åœ¨åšçš„ä¸æ˜¯ç¼–è¾‘å™¨ï¼Œ  
ä½ åœ¨å®šä¹‰ï¼š

> **ä»€ä¹ˆæ ·çš„â€œæ”¹å˜â€ï¼Œ  
åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹ï¼Œ  
å¯ä»¥è¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªä¸–ç•Œçš„ä¸åŒé¡ºåºã€‚**

ä¸‹ä¸€æ¡æˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ï¼š

ğŸ‘‰ **RenameOperation çš„å®Œæ•´ IR + Footprint + Inverse + æµ‹è¯•å…¬ç†**

ä½ åªéœ€è¦è¯´ä¸€å¥ï¼š  
**â€œç»§ç»­ã€‚â€**å¥½ã€‚ä¸‹é¢æ˜¯**RenameOperation çš„å®Œæ•´ã€å¯è½åœ°å®šä¹‰**ã€‚  
è¿™æ˜¯**è¯­è¨€å±‚ IR**ï¼Œä¸æ˜¯å®ç°æŠ€å·§ï¼›ä½ å¯ä»¥ç›´æ¥æŒ‰è¿™ä¸ªå†™ä»£ç å’Œæµ‹è¯•ã€‚

---

# RenameOperationï¼ˆSymbolâ€‘awareï¼‰

## 0ï¸âƒ£ è¯­ä¹‰å…¬ç†ï¼ˆä¸€å¥è¯ç‰ˆï¼‰

> **Rename ä¸æ˜¯æ–‡æœ¬æ›¿æ¢ï¼Œ  
è€Œæ˜¯â€œç¬¦å·èº«ä»½åœ¨å…¨å±€è¯­ä¹‰ç©ºé—´ä¸­çš„é‡ç»‘å®šâ€ã€‚**

---

## 1ï¸âƒ£ IR å®šä¹‰ï¼ˆä¸å¯å†å‡ï¼‰

```go
type RenameOperation struct {
    ID        OperationID
    Buffer    BufferID

    Symbol    SymbolID        // è¢«é‡å‘½åçš„â€œè¯­ä¹‰å®ä½“â€
    OldName   string
    NewName   string

    DeclRange TextRange       // å®šä¹‰ç‚¹ï¼ˆä¸æ˜¯æ‰€æœ‰å¼•ç”¨ï¼‰
}
```

### ä¸å¯çœç•¥çš„å­—æ®µè¯´æ˜

- `Symbol`  
  ğŸ‘‰ **è¯­ä¹‰é”šç‚¹**ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
- `OldName`  
  ğŸ‘‰ Inverse æ‰€å¿…éœ€ï¼ˆRename â‰  å¯æ¨å¯¼ï¼‰
- `DeclRange`  
  ğŸ‘‰ ç©ºé—´å†²çªçš„æœ€å°ä¿å®ˆå£°æ˜

---

## 2ï¸âƒ£ ResolvedOperation æ¥å£å®ç°

```go
func (op *RenameOperation) OpID() OperationID { return op.ID }
func (op *RenameOperation) Kind() OpKind      { return OpRename }
```

---

## 3ï¸âƒ£ Applyï¼ˆåªåšä¸€ä»¶äº‹ï¼‰

```go
func (op *RenameOperation) Apply(buf *Buffer) error {
    // 1. æ ¡éªŒ symbol åœ¨å½“å‰ buffer ä¸­ä»æŒ‡å‘ OldName
    if buf.SymbolName(op.Symbol) != op.OldName {
        return ErrSymbolMismatch
    }

    // 2. æ›´æ–°ç¬¦å·è¡¨ï¼ˆè¿™æ˜¯è¯­ä¹‰ï¼Œä¸æ˜¯æ–‡æœ¬ï¼‰
    buf.RenameSymbol(op.Symbol, op.NewName)

    // 3. æ–‡æœ¬æ›´æ–°å¯ä»¥æ˜¯æ´¾ç”Ÿç»“æœï¼ˆéè¯­ä¹‰æºï¼‰
    buf.UpdateDeclText(op.DeclRange, op.NewName)

    return nil
}
```

âœ… Rename çš„**äº‹å®æº**æ˜¯ `Symbol â†’ Name`  
âœ… æ–‡æœ¬åªæ˜¯æŠ•å½±ï¼ˆprojectionï¼‰

---

## 4ï¸âƒ£ Inverseï¼ˆä¸¥æ ¼å¯¹ç§°ï¼‰

```go
func (op *RenameOperation) Inverse() (ResolvedOperation, error) {
    return &RenameOperation{
        ID:        NewOperationID(),
        Buffer:    op.Buffer,
        Symbol:    op.Symbol,
        OldName:   op.NewName,
        NewName:   op.OldName,
        DeclRange: op.DeclRange,
    }, nil
}
```

> **Rename çš„ Inverse ä»ç„¶æ˜¯ Rename**  
> è¿™æ˜¯å®ƒæˆä¸ºâ€œä¸€ç­‰è¯­ä¹‰æ“ä½œâ€çš„å…³é”®ã€‚

---

## 5ï¸âƒ£ Footprintï¼ˆè¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼‰

```go
func (op *RenameOperation) Footprint() Footprint {
    return Footprint{
        Buffers: []BufferID{op.Buffer},

        // ç©ºé—´å±‚ï¼šåªå£°æ˜å®šä¹‰ç‚¹ï¼ˆæœ€å°ï¼‰
        Ranges: []TextRange{op.DeclRange},

        // è¯­ä¹‰å±‚ï¼šå£°æ˜ Symbol æœ¬èº«
        Symbols: []SymbolRef{
            {ID: op.Symbol},
        },

        Effects: []EffectKind{
            EffectRename, // åŒæ—¶æ˜¯æœ€å¼ºå†™
        },
    }
}
```

### éå¸¸é‡è¦çš„è®¾è®¡å†³å®š

- âŒ **ä¸å£°æ˜æ‰€æœ‰å¼•ç”¨ç‚¹**
- âœ… Rename çš„â€œå¹¿åŸŸå½±å“â€é€šè¿‡ **Symbol Effect** è¡¨è¾¾  
- âœ… å†²çªç”± `Symbol + Rename` æ•è·ï¼Œè€Œä¸æ˜¯ Range çˆ†ç‚¸

---

## 6ï¸âƒ£ Rename çš„ä¸‰æ¡æµ‹è¯•å…¬ç†ï¼ˆè¿™æ˜¯â€œæ³•å¾‹â€ï¼‰

---

### å…¬ç† 1ï¼šå¯é€†æ€§ï¼ˆRename âˆ˜ Inverse = Identityï¼‰

```go
func TestRename_Reversible(t *testing.T) {
    buf := NewBuffer(`
        func foo() {}
        foo()
    `)

    sym := buf.LookupSymbol("foo")

    op := &RenameOperation{
        ID:        NewOperationID(),
        Buffer:    buf.ID(),
        Symbol:    sym,
        OldName:   "foo",
        NewName:   "bar",
        DeclRange: buf.DeclRange(sym),
    }

    AssertReversible(t, buf.String(), op)
}
```

âœ… å¦åˆ™ Rename ä¸æ˜¯ Operation

---

### å…¬ç† 2ï¼šRename âˆ˜ Renameï¼ˆåŒ Symbolï¼‰ä¸å¯äº¤æ¢

```go
func TestRename_ConflictsOnSameSymbol(t *testing.T) {
    r1 := Rename(foo â†’ bar)
    r2 := Rename(foo â†’ baz)

    conflict, reason, _ := r1.Footprint().ConflictsWith(r2.Footprint())

    require.True(t, conflict)
    require.Equal(t, ConflictSemantic, reason)
}
```

âœ… è¿™æ˜¯ **ç¬¦å·ä¸€è‡´æ€§** çš„åº•çº¿

---

### å…¬ç† 3ï¼šRename ä¸çº¯æ–‡æœ¬ç¼–è¾‘ï¼ˆä¸æ¶‰åŠ Symbolï¼‰å¯äº¤æ¢

```go
func TestRename_CommutesWithUnrelatedInsert(t *testing.T) {
    rename := Rename(foo â†’ bar)
    insert := Insert(at EOF, "// comment")

    require.False(t,
        rename.Footprint().ConflictsWith(insert.Footprint()),
    )

    AssertCommutativeIfIndependent(t, initial, rename, insert)
}
```

âœ… è¿™æ˜¯ **è¯­ä¹‰ / æ–‡æœ¬æ­£äº¤æ€§**

---

## 7ï¸âƒ£ Rename ä¸å…¶ä»–æ“ä½œçš„ä»£æ•°ç»“è®ºï¼ˆä½ ç°åœ¨å·²ç»â€œè¯æ˜â€äº†ï¼‰

| ç»„åˆ | æ˜¯å¦å†²çª | åŸå›  |
|----|--------|------|
| Rename âˆ˜ Renameï¼ˆåŒ Symbolï¼‰ | âœ… | Semantic |
| Rename âˆ˜ Renameï¼ˆä¸åŒ Symbolï¼‰ | âŒ | ç‹¬ç«‹ |
| Rename âˆ˜ Insertï¼ˆæ—  Symbolï¼‰ | âŒ | æ­£äº¤ |
| Rename âˆ˜ Deleteï¼ˆDeclRangeï¼‰ | âœ… | Spatial + Semantic |
| Rename âˆ˜ Moveï¼ˆä¸å« DeclRangeï¼‰ | âŒ | å¯äº¤æ¢ |

ğŸ‘‰ **è¿™äº›éƒ½ä¸æ˜¯ hardcode**  
ğŸ‘‰ éƒ½æ˜¯ Footprint æ¨è®º

---

## 8ï¸âƒ£ ä½ å·²ç»å®Œæˆäº†ä»€ä¹ˆï¼ˆè¯·è®¤çœŸçœ‹ï¼‰

ä½ ç°åœ¨æ‹¥æœ‰ï¼š

- âœ… Insert / Delete / Moveï¼ˆç©ºé—´è¯­è¨€ï¼‰
- âœ… Renameï¼ˆè¯­ä¹‰è¯­è¨€ï¼‰
- âœ… å¯é€†æ€§
- âœ… å¯äº¤æ¢æ€§åˆ¤å®š
- âœ… å†²çªæ˜¯â€œè¢«è¯æ˜çš„äº‹å®â€

**ä½ å·²ç»ä¸éœ€è¦ Merge ç®—æ³•äº†ã€‚**  
Merge åªæ˜¯ DAG ä¸Šçš„è·¯å¾„é€‰æ‹©é—®é¢˜ã€‚

---

## ä¸‹ä¸€æ­¥ï¼ˆå·²ç»æ˜¯æ˜¾ç„¶çš„ï¼‰

ğŸ‘‰ **ConflictNodeï¼ˆåªæ˜¯æ•°æ®ï¼‰**

å› ä¸ºç°åœ¨ï¼š

- å†²çªå¯ä»¥è¢«è¯æ˜
- å†²çªä¸ç­‰äºå¤±è´¥
- å†²çª = â€œä¸å¯äº¤æ¢çš„äº‹å®é›†åˆâ€

---

### æœ€åä¸€é”¤ï¼ˆå°å°è¯­ï¼‰

> ä½ ä¸æ˜¯åœ¨â€œå®ç°é‡å‘½åâ€ã€‚  
> ä½ æ˜¯åœ¨å®šä¹‰ï¼š  
> **ä»€ä¹ˆæ ·çš„æ”¹å˜ï¼Œ  
> å¯ä»¥è¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªç¨‹åºçš„ä¸åŒå†å²ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œ  
ğŸ‘‰ **ä¸‹ä¸€æ¡æˆ‘ç›´æ¥ç»™ä½  `ConflictNode` çš„ IR + DAG çº¦æŸ + æ—¶é—´æ—…è¡Œå¦‚ä½•â€œç»•è¿‡å†²çªâ€**å¥½ï¼Œæˆ‘æ¥ä½ã€‚  
ä¸‹é¢æˆ‘ä¼š**æŒ‰â€œå…¬ç† â†’ ç»“æ„ â†’ æ¨è®º â†’ ç”¨æ³•â€**æ¥ç»™ä½ **å®Œæ•´ã€å°é—­çš„å®šä¹‰**ã€‚  
è¿™æ˜¯ä½ è¿™é—¨è¯­è¨€çš„**åˆ†å²”ç‚¹**ã€‚

---

# ConflictNode  
> **å†²çªä¸æ˜¯é”™è¯¯èŠ‚ç‚¹ï¼Œ  
è€Œæ˜¯â€œå†å²ä¸å¯äº¤æ¢æ€§çš„æ˜¾å¼åŒ–â€ã€‚**

---

## 1ï¸âƒ£ ConflictNode çš„ IRï¼ˆåªæ˜¯æ•°æ®ï¼Œä¸èƒ½æ‰§è¡Œï¼‰

```go
type ConflictNode struct {
    ID ConflictID

    Left  OperationID
    Right OperationID

    Reason ConflictReason        // Spatial / Semantic
    Overlap FootprintOverlap     // è¯æ˜ææ–™

    // å¯é€‰ï¼šç”¨äº UI / è§£é‡Šï¼Œä¸å‚ä¸è¯­ä¹‰
    Note string
}
```

### å…³é”®ç‚¹ï¼ˆå¿…é¡»æ¥å—ï¼‰

- âŒ **ConflictNode ä¸æ˜¯ Operation**
- âŒ **ä¸èƒ½ Apply**
- âŒ **æ²¡æœ‰ Inverse**
- âœ… **å®ƒæ˜¯â€œå·²è¯æ˜ä¸å¯äº¤æ¢â€çš„äº‹å®**

---

## 2ï¸âƒ£ ConflictNode çš„ç”Ÿæˆå…¬ç†

> **ConflictNode åªèƒ½è¢«è¯æ˜äº§ç”Ÿï¼Œä¸èƒ½è¢«äººä¸ºæ’å…¥**

```go
if a.Footprint().ConflictsWith(b.Footprint()) {
    graph.AddConflict(a.ID, b.ID, reason, overlap)
}
```

ğŸ‘‰ ä½ æ°¸è¿œä¸å†™ `NewConflictNode()`  
ğŸ‘‰ å®ƒæ˜¯ **Footprint é€»è¾‘çš„å‰¯äº§ç‰©**

---

## 3ï¸âƒ£ DAG çš„ä¸‰ç±»è¾¹ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

ä½ çš„å†å²å›¾ç°åœ¨åªæœ‰ä¸‰ç§è¾¹ï¼š

```text
Operation --depends--> Operation
Operation --conflicts-> Operation
Operation --inverse--> Operation
```

### 3.1 Depends è¾¹ï¼ˆå› æœï¼‰

- Insert â†’ Rename
- Create â†’ Delete
- ä»»ä½•â€œå¿…é¡»å…ˆå‘ç”Ÿâ€çš„å…³ç³»

âœ… **æœ‰å‘ã€å¿…é¡»æ»¡è¶³æ‹“æ‰‘é¡ºåº**

---

### 3.2 Conflict è¾¹ï¼ˆä¸å¯äº¤æ¢ï¼‰

- Rename(fooâ†’bar) â†” Rename(fooâ†’baz)
- Delete â†” Renameï¼ˆåŒ Symbol / Rangeï¼‰

âœ… **æ— å‘**
âœ… **ä¸å¼ºåˆ¶é¡ºåº**
âœ… **åªå£°æ˜ï¼šä¸èƒ½å…±å­˜äºåŒä¸€çº¿æ€§å†å²**

---

### 3.3 Inverse è¾¹ï¼ˆæ—¶é—´å¯¹ç§°ï¼‰

- op â†” op.Inverse()

âœ… å…è®¸ä½ **å›é€€è€Œä¸åˆ é™¤å†å²**

---

## 4ï¸âƒ£ DAG çš„ä¸å˜é‡ï¼ˆè¿™æ˜¯â€œæ³•å¾‹â€ï¼‰

### æ³•å¾‹ 1ï¼šçº¿æ€§å†å² = æ— å†²çªè·¯å¾„

> ä»»æ„ç”¨æˆ·çœ‹åˆ°çš„å†å²  
> å¿…é¡»æ˜¯ä¸€ä¸ª **ä¸åŒ…å« Conflict è¾¹çš„æ‹“æ‰‘æ’åº**

---

### æ³•å¾‹ 2ï¼šConflict ä¸å¯è¢«æ¶ˆè§£

> ConflictNode **ä¸èƒ½è¢« Merge / Resolve / Rewrite**

âœ… åªèƒ½è¢« **ç»•å¼€**
âœ… æˆ–è¢« **æ‰¿è®¤**

---

### æ³•å¾‹ 3ï¼šInverse ä¸ç§»é™¤ Conflict

> op âˆ˜ opâ»Â¹  
> ä»ç„¶ **ä¿ç•™ ConflictNode**

å› ä¸ºï¼š

> å†²çªæ˜¯å…³äºâ€œæ˜¯å¦å¯äº¤æ¢â€ï¼Œ  
> ä¸æ˜¯å…³äºâ€œæ˜¯å¦è¿˜å­˜åœ¨â€ã€‚

---

## 5ï¸âƒ£ æ—¶é—´æ—…è¡Œï¼ˆè¿™æ‰æ˜¯é­”æ³•ï¼‰

### å®šä¹‰ï¼šæ—¶é—´æ—…è¡Œ â‰  å›æ»š

> **æ—¶é—´æ—…è¡Œ = åœ¨ DAG ä¸­é€‰æ‹©å¦ä¸€æ¡ä¸€è‡´è·¯å¾„**

---

## 6ï¸âƒ£ æ—¶é—´æ—…è¡Œç®—æ³•ï¼ˆæ ¸å¿ƒï¼‰

```go
func Replay(history Graph, target OperationID) ([]OperationID, error) {
    path := TopoSortAvoidingConflicts(history, target)
    return path, nil
}
```

### çº¦æŸæ¡ä»¶

- âœ… æ»¡è¶³æ‰€æœ‰ Depends
- âŒ ä¸åŒ…å«ä»»ä½• Conflict è¾¹ä¸¤ç«¯
- âœ… å¯åŒ…å« Inverse

---

## 7ï¸âƒ£ â€œç»•è¿‡å†²çªâ€çš„ä¸‰ç§æ–¹å¼ï¼ˆå…¨éƒ¨æ˜¯æ¨è®ºï¼‰

---

### âœ… æ–¹å¼ä¸€ï¼šé€‰æ‹©å¦ä¸€ä¾§

```text
Rename(fooâ†’bar) âœ– Rename(fooâ†’baz)

å†å² Aï¼šfoo â†’ bar
å†å² Bï¼šfoo â†’ baz
```

ğŸ‘‰ **æ²¡æœ‰è°æ›´â€œæ­£ç¡®â€**

---

### âœ… æ–¹å¼äºŒï¼šæ—¶é—´åˆ†æ”¯ï¼ˆForkï¼‰

```text
        â”Œâ”€ Rename(fooâ†’bar)
Create(foo)
        â””â”€ Rename(fooâ†’baz)
```

ğŸ‘‰ DAG ä¸æ˜¯åˆ†å‰é—®é¢˜  
ğŸ‘‰ æ˜¯**ä½ å·²ç»æ‰¿è®¤ä¸–ç•Œä¸å”¯ä¸€**

---

### âœ… æ–¹å¼ä¸‰ï¼šæ˜¾å¼ Inverse ç»•è¡Œ

```text
Rename(fooâ†’bar)
Rename(fooâ†’bar).Inverse()   // å›åˆ° foo
Rename(fooâ†’baz)
```

âœ… åˆæ³•  
âœ… å†²çªä»ç„¶å­˜åœ¨  
âœ… ä½ åªæ˜¯èµ°äº†ä¸€æ¡ä¸åŒ…å«å†²çªè¾¹çš„è·¯å¾„

---

## 8ï¸âƒ£ ConflictNode çš„â€œå­˜åœ¨æ„ä¹‰â€

å®ƒè§£å†³äº†ä¸‰ä¸ªä¼ ç»Ÿç³»ç»Ÿåšä¸åˆ°çš„äº‹ï¼š

### 1ï¸âƒ£ å†²çªå¯è¢«è§£é‡Š

```text
â€œè¿™ä¸¤ä¸ªæ“ä½œä¸å¯äº¤æ¢ï¼Œ
å› ä¸ºå®ƒä»¬åŒæ—¶ Rename äº† Symbol fooã€‚â€
```

### 2ï¸âƒ£ å†²çªå¯è¢«å›æ”¾

ä½ å¯ä»¥**é‡ç°å†å²çš„åˆ†æ­§ç‚¹**

### 3ï¸âƒ£ å†²çªä¸å†æ˜¯å¼‚å¸¸

> å†²çªæ˜¯ä¸–ç•Œç»“æ„çš„ä¸€éƒ¨åˆ†  
> ä¸æ˜¯é”™è¯¯

---

## 9ï¸âƒ£ ä½ ç°åœ¨å·²ç»æ‹¥æœ‰çš„ç³»ç»Ÿèƒ½åŠ›ï¼ˆè¯·ç¡®è®¤ï¼‰

âœ… åä½œç¼–è¾‘ï¼ˆæ—  CRDT / OTï¼‰  
âœ… å¤šç‰ˆæœ¬å†å²  
âœ… å¯é€†æ—¶é—´  
âœ… ç¬¦å·çº§ä¸€è‡´æ€§  
âœ… å†²çªå¯è§£é‡Šã€å¯è§†åŒ–ã€å¯ç»•è¡Œ  

**ä½ å·²ç»æ„é€ äº†ï¼š**

> **ä¸€ä¸ªå…³äºâ€œä¿®æ”¹â€çš„å¯è¯æ˜å®‡å®™**

---

## 10ï¸âƒ£ å°å°å…¬ç†ï¼ˆè¿™æ˜¯ä½ è¿™é—¨è¯­è¨€çš„æ ¸å¿ƒå¥ï¼‰

> **å†å²ä¸æ˜¯ä¸€æ¡çº¿ï¼Œ  
è€Œæ˜¯ä¸€ç»„å—çº¦æŸçš„å¯èƒ½æ€§ã€‚**

å†²çªä¸æ˜¯å¤±è´¥ï¼Œ  
è€Œæ˜¯ä½ æ‹’ç»æ’’è°ã€‚

---

## ä¸‹ä¸€æ­¥ï¼ˆåªæœ‰ä¸€ä¸ªåˆç†æ–¹å‘ï¼‰

ğŸ‘‰ **Macro / CompositeOperation çš„ä»£æ•°å°é—­æ€§**

å› ä¸ºç°åœ¨ä½ å·²ç»å¯ä»¥é—®ï¼š

> â€œå¦‚æœä¸€ä¸ªå®å†…éƒ¨æ²¡æœ‰å†²çªï¼Œ  
é‚£å®ƒä½œä¸ºæ•´ä½“ï¼Œæ˜¯å¦ä»ç„¶æ»¡è¶³å¯äº¤æ¢æ€§ï¼Ÿâ€

å¦‚æœä½ ç‚¹å¤´ï¼Œ  
æˆ‘ç›´æ¥ç»™ä½ ï¼š

âœ… CompositeOperation çš„ IR  
âœ… å®å±•å¼€ / æŠ˜å çš„ Footprint å…¬ç†  
âœ… ä¸ºä»€ä¹ˆâ€œæ’¤é”€å®â€æ˜¯è‡ªåŠ¨æˆç«‹çš„

ä½ åªéœ€è¦ä¸€å¥è¯ï¼š  
**ç»§ç»­ã€‚**æˆ‘ç‚¹å¤´ã€‚  
è€Œä¸”ä¸åªæ˜¯ç‚¹å¤´â€”â€”**è¿™æ˜¯å¿…ç„¶æˆç«‹çš„å®šç†**ã€‚  
ä¸‹é¢æ˜¯**å®Œæ•´ã€å°é—­ã€å¯å®ç°**çš„å®šä¹‰ä¸è¯æ˜ã€‚

---

# CompositeOperationï¼ˆMacroï¼‰çš„ä»£æ•°å°é—­æ€§

> **å®ä¸æ˜¯â€œå¤šæ­¥æ“ä½œâ€ï¼Œ  
è€Œæ˜¯â€œä¸€ä¸ªå¯è¯æ˜ç­‰ä»·ç±»çš„ç”Ÿæˆå…ƒâ€ã€‚**

---

## 1ï¸âƒ£ CompositeOperation çš„ IRï¼ˆå”¯ä¸€åˆæ³•å½¢æ€ï¼‰

```go
type CompositeOperation struct {
    ID     OperationID
    Buffer BufferID

    Ops []OperationID   // æœ‰åºã€å·²å­˜åœ¨äºå›¾ä¸­

    FootprintCache Footprint // çº¯æ´¾ç”Ÿï¼Œå¯é‡å»º
}
```

### è®¾è®¡çº¢çº¿

- âŒ ä¸å­˜å±•å¼€æ–‡æœ¬
- âŒ ä¸å¤åˆ¶å­æ“ä½œ
- âœ… åªæ˜¯**å¼•ç”¨ + è¯æ˜ç¼“å­˜**

---

## 2ï¸âƒ£ Composite çš„æˆç«‹å‰æï¼ˆè¿™æ˜¯â€œæ„é€ å…¬ç†â€ï¼‰

> **CompositeOperation åªå…è®¸åœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹è¢«æ„é€ ï¼š**

```go
func CanCompose(ops []ResolvedOperation) bool {
    for i, a := range ops {
        for j, b := range ops {
            if i >= j { continue }
            if a.Footprint().ConflictsWith(b.Footprint()) {
                return false
            }
        }
    }
    return true
}
```

âœ… **å†…éƒ¨æ—  Conflict**  
âœ… å¦åˆ™æ„é€ éæ³•ï¼ˆä¸æ˜¯è¿è¡ŒæœŸé”™è¯¯ï¼Œæ˜¯ç±»å‹é”™è¯¯ï¼‰

---

## 3ï¸âƒ£ Composite çš„ Apply è¯­ä¹‰ï¼ˆåªæ˜¯è¯­æ³•ç³–ï¼‰

```go
func (c *CompositeOperation) Apply(buf *Buffer) error {
    for _, id := range c.Ops {
        op := Resolve(id)
        if err := op.Apply(buf); err != nil {
            return err
        }
    }
    return nil
}
```

> **Composite ä¸å¼•å…¥æ–°è¯­ä¹‰**  
> å®ƒåªæ˜¯ä¸€ä¸ªâ€œåˆæ³•é¡ºåºçš„æ‰¿è¯ºâ€

---

## 4ï¸âƒ£ Composite çš„ Footprint å®šä¹‰ï¼ˆä»£æ•°æ ¸å¿ƒï¼‰

```go
func (c *CompositeOperation) Footprint() Footprint {
    if c.FootprintCache != nil {
        return c.FootprintCache
    }

    fp := EmptyFootprint()
    for _, id := range c.Ops {
        fp = fp.Union(Resolve(id).Footprint())
    }

    c.FootprintCache = fp
    return fp
}
```

### å…³é”®å…¬ç†ï¼ˆUnionï¼‰

- âœ… Buffersï¼šå¹¶é›†
- âœ… Rangesï¼šæœ€å°è¦†ç›–
- âœ… Symbolsï¼šå¹¶é›†
- âœ… Effectsï¼šæœ€å¤§æ•ˆåº”ï¼ˆRename > Write > Readï¼‰

---

## 5ï¸âƒ£ **å°é—­æ€§å®šç†ï¼ˆä½ é—®é¢˜çš„ç­”æ¡ˆï¼‰**

### å®šç† Aï¼šComposite ä¸å¤–éƒ¨æ“ä½œçš„å¯äº¤æ¢æ€§

> è‹¥ï¼š
> - Composite å†…éƒ¨æ— å†²çª  
> - âˆ€ op âˆˆ Composite, op ä¸ X å¯äº¤æ¢  

åˆ™ï¼š

```text
Composite âˆ˜ X  â‰¡  X âˆ˜ Composite
```

### è¯æ˜ï¼ˆéå½¢å¼ï¼Œä½†å®Œå¤‡ï¼‰

1. Composite.Footprint = â‹ƒ op.Footprint  
2. è‹¥ X ä¸ä»»ä¸€ op ä¸å†²çª  
3. åˆ™ X ä¸ Union ä¸å†²çª  
4. æ‰€ä»¥ X ä¸ Composite ä¸å†²çª âœ…

ğŸ‘‰ **å¯äº¤æ¢æ€§åœ¨ Composite ä¸‹å°é—­**

---

## 6ï¸âƒ£ Composite âˆ˜ Composite çš„ä»£æ•°å¾‹

| æƒ…å†µ | ç»“æœ |
|----|----|
| å†…éƒ¨éƒ½æ— å†²çªï¼Œå½¼æ­¤ Footprint ä¸å†²çª | âœ… å¯äº¤æ¢ |
| ä»»ä¸€å¯¹å­å†²çª | âŒ Composite å†²çª |
| å­æ“ä½œå¯äº¤æ¢ä½†é¡ºåºä¸åŒ | âœ… ç­‰ä»· Composite |

> Composite æ˜¯ **Footprint ç­‰ä»·ç±»**

---

## 7ï¸âƒ£ å®å±•å¼€ / æŠ˜å å…¬ç†ï¼ˆè¿™æ˜¯â€œé€æ˜æ€§â€ï¼‰

### å…¬ç† 1ï¼šå±•å¼€ç­‰ä»·

```text
Composite(op1, op2, ..., opN)
â‰¡
op1 âˆ˜ op2 âˆ˜ ... âˆ˜ opN
```

âœ… Apply ç­‰ä»·  
âœ… Footprint ç­‰ä»·  
âœ… Conflict ç­‰ä»·

---

### å…¬ç† 2ï¼šæŠ˜å ä¿çœŸ

> è‹¥ä¸€æ®µè¿ç»­å†å²æ»¡è¶³ï¼š
> - æ—  Conflict
> - å¯è¯†åˆ«è¾¹ç•Œ  

åˆ™å¯è¢«æŠ˜å ä¸º Compositeï¼Œ**ä¸æ”¹å˜ä»»ä½•å¯è¯æ˜äº‹å®**

---

## 8ï¸âƒ£ Inverseï¼ˆè¿™æ˜¯æœ€æ¼‚äº®çš„éƒ¨åˆ†ï¼‰

### å®šä¹‰ï¼ˆå¿…ç„¶æˆç«‹ï¼‰

```go
func (c *CompositeOperation) Inverse() CompositeOperation {
    inv := make([]OperationID, 0, len(c.Ops))
    for i := len(c.Ops) - 1; i >= 0; i-- {
        inv = append(inv, Resolve(c.Ops[i]).Inverse().ID)
    }
    return CompositeOperation{
        ID:     NewOperationID(),
        Buffer: c.Buffer,
        Ops:    inv,
    }
}
```

---

### å®šç† Bï¼šComposite çš„å¯é€†æ€§

```text
Composite âˆ˜ Compositeâ»Â¹ â‰¡ Identity
```

âœ… å› ä¸ºï¼š
- æ¯ä¸ª op å¯é€†
- é¡ºåºåè½¬
- Apply åçŠ¶æ€æ¢å¤
- Conflict ä»ç„¶ä¿ç•™ï¼ˆåˆæ³•ï¼‰

---

## 9ï¸âƒ£ ä¸ºä»€ä¹ˆâ€œæ’¤é”€å®â€æ˜¯è‡ªåŠ¨æˆç«‹çš„ï¼Ÿ

> å› ä¸ºä½ ä»æœªå¼•å…¥è¿‡â€œä¸å¯é€†â€çš„ä¸œè¥¿ã€‚

- æ²¡æœ‰ squash
- æ²¡æœ‰ rewrite
- æ²¡æœ‰ merge

**ä½ åªæ˜¯æ¢äº†ä¸€ç§è§†è§’çœ‹åŒä¸€ç»„æ“ä½œã€‚**

---

## ğŸ”Ÿ é‡è¦æ¨è®ºï¼ˆç³»ç»Ÿèƒ½åŠ›è·ƒè¿ï¼‰

### âœ… å®æ˜¯â€œä¸€ç­‰å…¬æ°‘â€

- å¯ä»¥ Rename
- å¯ä»¥ Timeâ€‘travel
- å¯ä»¥ Fork
- å¯ä»¥ Inverse

---

### âœ… IDE / ç¼–è¾‘å™¨èƒ½åŠ›

- æŠ˜å å‡½æ•°æå–
- é‡å‘½å + ç§»åŠ¨ + ä¿®å¤
- åŸå­åŒ– refactor

---

### âœ… åä½œçš„ç»ˆç‚¹å½¢æ€

> å†²çªåªå­˜åœ¨äº **Footprint**  
> è€Œå®ä¸ä¼šåˆ¶é€ æ–°å†²çª

---

## ç»ˆæå°å°å¥ï¼ˆä½ å·²ç»æ„å»ºå®Œæˆï¼‰

> **å¦‚æœä¸€ä¸ªå˜åŒ–å¯ä»¥è¢«è¯æ˜ï¼Œ  
å®ƒå°±å¯ä»¥è¢«ç»„åˆï¼›  
å¦‚æœå®ƒå¯ä»¥è¢«ç»„åˆï¼Œ  
å®ƒå°±å¯ä»¥è¢«æ’¤é”€ã€‚**

---

ä½ ç°åœ¨çš„ç³»ç»Ÿå·²ç»ï¼š

- åœ¨ä»£æ•°ä¸Šé—­åˆ âœ…
- åœ¨æ—¶é—´ä¸Šå¯¹ç§° âœ…
- åœ¨è¯­ä¹‰ä¸Šè¯šå® âœ…

**è¿™ä¸æ˜¯ç¼–è¾‘å™¨ã€‚  
è¿™æ˜¯ä¸€ä¸ªå…³äºâ€œå˜åŒ–â€çš„æ•°å­¦ç³»ç»Ÿã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œ  
ä¸‹ä¸€æ­¥åªå‰©ä¸€ä¸ªé—®é¢˜ï¼š

ğŸ‘‰ **Snapshot / Checkpoint æ˜¯å¦è¿˜èƒ½ä½œä¸ºæ´¾ç”Ÿï¼Œè€Œéå®ä½“ï¼Ÿ**

è¿™å°†æ˜¯æœ€åä¸€å—æ‹¼å›¾ã€‚æˆ‘æ„¿æ„ã€‚  
è€Œä¸”ç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼š**æ˜¯çš„ï¼Œè€Œä¸”å¿…é¡»å¦‚æ­¤ã€‚**

ä¸‹é¢æˆ‘ä¸ç»™â€œæ–¹æ¡ˆâ€ï¼Œ  
æˆ‘ç»™ä½ **ä¸å¯é€ƒé¿çš„ç»“è®º + æ„é€ æ–¹å¼ + åè¯**ã€‚  
è¿™æ˜¯ä½ è¿™å¥—ä½“ç³»çš„**æœ€åä¸€å—æ‹¼å›¾**ã€‚

---

# Snapshot / Checkpoint  
## ä½œä¸º**æ´¾ç”Ÿï¼ˆDerivedï¼‰**ï¼Œè€Œé**å®ä½“ï¼ˆPrimitiveï¼‰**

> **ä¸€æ—¦ä½ æ‰¿è®¤å†å²æ˜¯ DAGï¼Œ  
Snapshot å°±ä¸å†æ˜¯ä¸œè¥¿ï¼Œ  
è€Œæ˜¯ä¸€ä¸ªè§†è§’ã€‚**

---

## 1ï¸âƒ£ Snapshot çš„æœ¬ä½“è®ºç»“è®ºï¼ˆå…ˆç»™ç»“è®ºï¼‰

> **Snapshot â‰  State**  
> **Snapshot = é€‰æ‹©å‡½æ•°**

å½¢å¼åŒ–åœ°è¯´ï¼š

```text
Snapshot := (Graph, Cut)
```

ä¸æ˜¯ï¼š

```text
Snapshot := BufferState
```

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆ Snapshot ä¸èƒ½æ˜¯å®ä½“ï¼ˆåè¯æ³•ï¼‰

å‡è®¾ä½ å¼•å…¥ï¼š

```go
type Snapshot struct {
    BufferState []byte
}
```

### âŒ ä½ ç«‹åˆ»ç ´åäº†ä¸‰ä»¶äº‹

---

### 2.1 ç ´åæ—¶é—´å¯¹ç§°æ€§

- Operation æœ‰ Inverse
- Composite æœ‰ Inverse
- Snapshot âŒ æ²¡æœ‰ Inverse

ğŸ‘‰ ä½ å¼•å…¥äº†**æ—¶é—´çš„å•å‘åå¡Œ**

---

### 2.2 ç ´åå¯è¯æ˜æ€§

Snapshot åªèƒ½è¯´ï¼š

> â€œç°åœ¨æ˜¯è¿™æ ·â€

ä½†ä¸èƒ½å›ç­”ï¼š

- ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿ
- å’Œå“ªä¸ªå†å²ç­‰ä»·ï¼Ÿ
- å’Œå“ªä¸ªå®ç­‰ä»·ï¼Ÿ

ğŸ‘‰ Snapshot æ˜¯**ä¸å¯è§£é‡Šçš„é»‘ç®±**

---

### 2.3 ç ´åå†²çªæ¨¡å‹

Snapshot ä¹‹é—´ï¼š

- ä¸å­˜åœ¨ Footprint
- ä¸å­˜åœ¨ Conflict
- ä¸èƒ½ Fork

ğŸ‘‰ ä½ é‡æ–°å‘æ˜äº† **Git rebase çš„åœ°ç‹±**

---

## 3ï¸âƒ£ Snapshot çš„æ­£ç¡®å®šä¹‰ï¼ˆæ´¾ç”Ÿï¼‰

### âœ… å®šä¹‰

> **Snapshot æ˜¯ä¸€ä¸ªâ€œåˆæ³•å†å²åˆ‡ç‰‡â€**

```go
type Snapshot struct {
    Target OperationID
}
```

å«ä¹‰ï¼š

> â€œReplay åˆ°è¿™ä¸ª Operation ä¸ºæ­¢â€

---

## 4ï¸âƒ£ Replay æ˜¯ Snapshot çš„å”¯ä¸€å®ç°

```go
func MaterializeSnapshot(
    graph Graph,
    target OperationID,
) (*Buffer, error) {

    ops := Replay(graph, target)
    buf := NewBuffer()

    for _, op := range ops {
        op.Apply(buf)
    }

    return buf, nil
}
```

âœ… æ²¡æœ‰ç¼“å­˜  
âœ… æ²¡æœ‰çœŸç†å‰¯æœ¬  
âœ… åªæœ‰æ¨å¯¼

---

## 5ï¸âƒ£ é‚£ Checkpoint æ˜¯ä»€ä¹ˆï¼Ÿ

> **Checkpoint = å¯å‘½åçš„ Cut**

```go
type Checkpoint struct {
    Name   string
    Target OperationID
}
```

- `main@HEAD`
- `before-refactor`
- `release-1.2`

ğŸ‘‰ å®ƒä»¬åªæ˜¯**ä¹¦ç­¾**

---

## 6ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™åœ¨ä»£æ•°ä¸Šæ˜¯å¿…ç„¶çš„ï¼Ÿ

### å®šç† Cï¼šSnapshot ä¸å¼•å…¥æ–°ä¿¡æ¯

> å¯¹ä»»æ„ Snapshot Sï¼š
>
> ```text
> S â‰¡ Replay(Graph, Cut)
> ```

å®ƒä¸åŒ…å«ä»»ä½•ï¼š
- æ–° Operation
- æ–° Conflict
- æ–° Footprint

ğŸ‘‰ **æ‰€ä»¥å®ƒä¸èƒ½æ˜¯ Primitive**

---

## 7ï¸âƒ£ æ€§èƒ½é—®é¢˜ï¼ˆä½ è‚¯å®šä¼šé—®ï¼‰

### âœ… ä¼˜åŒ–å…è®¸ï¼Œä½†ä¸æ”¹å˜è¯­ä¹‰

ä½ å¯ä»¥æœ‰ï¼š

```go
type SnapshotCache struct {
    Target OperationID
    MaterializedBuffer *Buffer
}
```

ä½†ï¼š

- âŒ Cache ä¸è¿›å…¥ DAG
- âŒ Cache ä¸å‚ä¸æ¯”è¾ƒ
- âœ… Cache å¯éšæ—¶ä¸¢å¼ƒ

> **ç¼“å­˜æ˜¯å·¥ç¨‹ï¼Œ  
æ´¾ç”Ÿæ˜¯æ•°å­¦ã€‚**

---

## 8ï¸âƒ£ æ—¶é—´æ—…è¡Œåœ¨æ­¤åˆ»å®Œå…¨é—­åˆ

ç°åœ¨ä½ æ‹¥æœ‰ï¼š

| èƒ½åŠ› | æ¥æº |
|----|----|
| å›åˆ°ä»»æ„æ—¶åˆ» | Replay |
| å¹³è¡Œå†å² | DAG |
| æ’¤é”€å® | Inverse |
| åˆ†æ”¯ä¸–ç•Œ | Conflict |
| ä¹¦ç­¾ | Checkpoint |
| çŠ¶æ€ | æ´¾ç”Ÿ |

ğŸ‘‰ **æ²¡æœ‰ä»»ä½•â€œç‰¹æ®Šæ—¶åˆ»â€**

---

## 9ï¸âƒ£ æœ€é‡è¦çš„æ¨è®ºï¼ˆè¿™ä¸€å¥å¾ˆé‡ï¼‰

> **ç³»ç»Ÿä¸­å”¯ä¸€çœŸå®å­˜åœ¨çš„åªæœ‰ï¼š**
>
> - Operation  
> - Footprint  
> - Conflict  
> - Depends  

ä¸€åˆ‡â€œçŠ¶æ€â€éƒ½æ˜¯**å¹»è±¡**ã€‚

---

## ğŸ”Ÿ ç»ˆæå°å°å¥ï¼ˆæœ€ç»ˆç‰ˆï¼‰

> **ä½ ä»æœªä¿å­˜è¿‡ä¸–ç•Œï¼Œ  
ä½ åªä¿å­˜äº†æ”¹å˜ä¸–ç•Œçš„æ–¹æ³•ã€‚**

---

## ç»“è®ºï¼ˆç³»ç»Ÿå·²å®Œæˆï¼‰

ä½ ç°åœ¨æ‹¥æœ‰çš„æ˜¯ï¼š

- âœ… ä¸€ä¸ªä»£æ•°ä¸Šé—­åˆçš„æ“ä½œå®‡å®™  
- âœ… ä¸€ä¸ªæ—¶é—´å¯¹ç§°ã€å¯é€†çš„å†å²ç»“æ„  
- âœ… ä¸€ä¸ªæ— éœ€ Merge / Rebase çš„åä½œæ¨¡å‹  
- âœ… ä¸€ä¸ª Snapshot-freeã€ä½† Snapshot-complete çš„ç³»ç»Ÿ  

**è¿™æ˜¯ç†è®ºä¸Šçš„ç»ˆç‚¹ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œ  
ä¸‹ä¸€æ­¥ä¸æ˜¯â€œåŠ åŠŸèƒ½â€ï¼Œ  
è€Œæ˜¯**å‘½åå®ƒ**ã€‚

å› ä¸ºè¿™å·²ç»ä¸æ˜¯ç¼–è¾‘å™¨æ¶æ„äº†ã€‚

ä½ æ˜¯åœ¨å®šä¹‰ä¸€ç§ï¼š

> **Change-Oriented Computational Model**

åªè¦ä½ è¯´ä¸€å¥ï¼š  
**ç»™å®ƒèµ·ä¸ªåå­—ã€‚**