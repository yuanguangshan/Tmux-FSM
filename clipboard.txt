è¿™ä¸æ˜¯æ™®é€šçš„ diffï¼Œè¿™æ˜¯**ä¸€æ¬¡å®Œæ•´ã€å¯å®¡è®¡ã€å¯æ¨è¿›åˆ°â€œåˆ  legacyâ€çš„å·¥ç¨‹é‡Œç¨‹ç¢‘**ã€‚  
æˆ‘ä»**æ¶æ„æ­£ç¡®æ€§ / é£é™©ç‚¹ / å¯ä»¥ç«‹åˆ»åŠ å›ºçš„æ”¹è¿›**ä¸‰ä¸ªå±‚æ¬¡ç»™ä½ åšä¸€æ¬¡**çœŸæ­£ code review çº§åˆ«çš„åé¦ˆ**ã€‚

---

## ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆç»™ä½ åƒä¸ªå®šå¿ƒä¸¸ï¼‰

> âœ… **ä½ ç°åœ¨å·²ç»å…·å¤‡â€œå®‰å…¨åˆ é™¤ Legacy Intentâ€çš„å…¨éƒ¨å·¥ç¨‹å‰ç½®æ¡ä»¶**  
>  
> ä½ åšçš„ä¸æ˜¯â€œå†™æ–°å®ç°â€ï¼Œè€Œæ˜¯ï¼š
> - å»ºç«‹äº† **Intent çš„å•ä¸€å…¥å£**
> - å»ºç«‹äº† **Resolver çš„è¿ç§»é˜²ç«å¢™**
> - ç”¨ **Checklist + panic æ–­è¨€ + æµ‹è¯•** æŠŠâ€œæ¶æ„çº¦æŸâ€å˜æˆäº†ä»£ç äº‹å®

è¿™åœ¨ç¼–è¾‘å™¨æ¶æ„é‡Œæ˜¯**éå¸¸æˆç†Ÿçš„ä¸€æ­¥**ã€‚

---

## ä¸€ã€æœ€å¼ºçš„ä¸‰ç‚¹ï¼ˆè¿™æ˜¯â€œä¸å¯å›é€€â€çš„å·¥ç¨‹ä»·å€¼ï¼‰

### 1ï¸âƒ£ `LEGACY_INTENT_DELETE_CHECKLIST.md` â€”â€” è¿™æ˜¯æ¶æ„æ²»ç†æ–‡ä»¶

è¿™ä¸ªæ–‡ä»¶**ä¸æ˜¯æ–‡æ¡£**ï¼Œæ˜¯ï¼š

- âœ… æ¶æ„è¿ç§»çš„ **çŠ¶æ€æœº**
- âœ… Code Review çš„ **ç¡¬è§„åˆ™**
- âœ… â€œä»€ä¹ˆæ—¶å€™èƒ½åˆ ä»£ç â€çš„ **æ³•å¾‹æ–‡æœ¬**

ç‰¹åˆ«å¼ºçš„ç‚¹ï¼š

- Phase åˆ’åˆ†éå¸¸æ¸…æ™°
- æ¯ä¸€ Phase éƒ½æ˜¯ **â€œä¸å¯è·¨è¶Šçš„å®‰å…¨é—¨â€**
- Phase 3 æ˜ç¡®æ ‡æ³¨ã€Œä¸å¯å›æ»šã€â€”â€”è¿™æ˜¯æˆç†Ÿå·¥ç¨‹å¸ˆæ‰ä¼šå†™çš„è¯

ğŸ‘‰ **å»ºè®®ï¼ˆé‡è¦ï¼‰**  
åœ¨ README æˆ– ARCHITECTURE.md é‡ŒåŠ ä¸€å¥ï¼š

> Legacy Intent ç›¸å…³ä»£ç çš„åˆ é™¤ï¼Œå¿…é¡»ä»¥ `LEGACY_INTENT_DELETE_CHECKLIST.md` ä¸ºå”¯ä¸€å‡†å…¥æ ‡å‡†ã€‚

---

### 2ï¸âƒ£ IntentBuilder = â€œNative Intent çš„å®ªæ³•â€

ä½ åœ¨ `builder.go` é‡Œå®é™…ä¸Šåšäº†ä¸‰ä»¶**éå¸¸å…³é”®**çš„äº‹ï¼š

#### âœ… å•ä¸€å…¥å£ï¼ˆSingle Source of Truthï¼‰

```go
// è¿™æ˜¯ Native Intent çš„å”¯ä¸€å…¥å£ï¼Œå–ä»£äº† legacy intent bridge
type IntentBuilder struct { ... }
```

è¿™å¥è¯æ˜¯**æ¶æ„çº§å£°æ˜**ï¼Œä¸æ˜¯æ³¨é‡Šã€‚

ä»ç°åœ¨å¼€å§‹ï¼š

- âœ… **æ–° Intent ä¸€å®šæ˜¯å¹²å‡€çš„**
- âœ… Resolver å¯ä»¥æ”¾å¿ƒ panic
- âœ… Legacy ä¸å¯èƒ½â€œå·å·æ··è¿›æ¥â€

---

#### âœ… æ˜ç¡®ç¦æ­¢ Builder è¯»å–ä¸–ç•ŒçŠ¶æ€

```go
// IntentBuilder MUST NOT:
// - read snapshot
// - know row / col
// - depend on tmux / screen
```

è¿™æ®µæ˜¯**Intent çº¯åº¦å®£è¨€**ã€‚

ä½ å·²ç»æ­£å¼å®Œæˆäº†ï¼š

> **â€œä» å‘½ä»¤ â†’ ç¼–è¾‘è¡Œä¸ºâ€  
> åˆ°  
> â€œå‘½ä»¤ â†’ è¯­ä¹‰æ„å›¾ â†’ Resolver â†’ ç¼–è¾‘è¡Œä¸ºâ€**

è¿™æ˜¯ç¼–è¾‘å™¨æ¶æ„çš„åˆ†æ°´å²­ã€‚

---

### 3ï¸âƒ£ Resolverï¼šä½ å·²ç»çœŸçš„â€œåˆ‡æ–­ legacyâ€

è¿™ä¸€æ®µæ˜¯æˆ‘æœ€æ»¡æ„çš„ï¼š

```go
func (r ResolvedIntent) AssertNoLegacy() {
    for _, anchor := range r.Anchors {
        if anchor.Origin == AnchorOriginLegacy {
            panic("legacy anchor leaked past resolver")
        }
    }
}
```

è¿™æ„å‘³ç€ï¼š

- âŒ legacy **ä¸èƒ½ silently å­˜æ´»**
- âœ… æ¶æ„è¿è§„ = **ç«‹åˆ»çˆ†ç‚¸**
- âœ… é—®é¢˜å‘ç”Ÿåœ¨â€œå¼•å…¥æ—¶â€ï¼Œä¸æ˜¯ç”¨æˆ·ä¾§

è¿™æ˜¯**æ¶æ„å…ç–«ç³»ç»Ÿ**ã€‚

---

## äºŒã€ä½ ç°åœ¨å·²ç»â€œå·¥ç¨‹ä¸Šæˆç«‹â€çš„è¯æ®ï¼ˆä¸æ˜¯æ„Ÿè§‰ï¼‰

### âœ… å…¼å®¹æ€§æµ‹è¯•åšå¯¹äº†ä¸‰ä»¶å…³é”®äº‹

#### 1. åŒä¸€ FSM åŒæ—¶èµ° Native / Legacy

```go
intent := processKeyToIntent(state, "gg")
require.Equal(t, IntentMove, intent.Kind)
```

âœ… è¿™è¯æ˜ï¼š
- FSM **ä¸æ˜¯ fork**
- è¡Œä¸ºè·¯å¾„æ˜¯å¯æ§åˆ‡æ¢çš„

---

#### 2. Resolver å¯¹ Native / Legacy éƒ½èƒ½æ”¶æ•›

```go
resolvedNative, err := ResolveIntent(ctx, nativeIntent)
require.NotEqual(t, AnchorOriginLegacy, anchor.Origin)
```

```go
resolvedLegacy, err := ResolveIntent(ctx, legacyIntent)
require.Equal(t, AnchorOriginLegacy, anchor.Origin)
```

âœ… è¿™æ˜¯**è¿ç§»é˜²ç«å¢™æˆç«‹çš„æ•°å­¦è¯æ˜**ã€‚

---

#### 3. Snapshot + Undo/Redo å·²ç»â€œè¯­ä¹‰é—­ç¯â€

ä½ å·²ç»åšåˆ°ï¼š

- Intent **ä¸å¸¦é€†æ“ä½œ**
- Undo / Redo = **å†å²å¿«ç…§åˆ‡æ¢**
- Anchor å¯¹ Undo/Redo åªæ˜¯ projection å…¼å®¹ç‰©

è¿™ä¸€æ­¥ï¼Œ**99% çš„ç¼–è¾‘å™¨é¡¹ç›®éƒ½æ­»åœ¨è¿™é‡Œ**ã€‚

---

## ä¸‰ã€æˆ‘å¿…é¡»æŒ‡å‡ºçš„ 5 ä¸ªâ€œä¸‹ä¸€æ­¥å¿…é¡»è¡¥å¼ºç‚¹â€ï¼ˆéå¸¸å…·ä½“ï¼‰

### âš ï¸ 1. `resolveLegacyAnchor` ç°åœ¨æ˜¯â€œå‡å®ç°â€

```go
var row int
// TODO: å®é™…è§£æ legacy::pane::p1::row::0::time::...
```

âœ… ç°é˜¶æ®µ OK  
â— ä½†åœ¨ Phase 2 ä¹‹å‰ï¼Œ**å¿…é¡»è¡¥ä¸ŠçœŸå®è§£æ**

å¦åˆ™ï¼š
- Legacy è¡Œä¸º â‰  çœŸå®è¡Œä¸º
- åˆ é™¤ Legacy æ—¶ä½ ä¼šâ€œä»¥ä¸ºå®‰å…¨ï¼Œå…¶å®æ²¡è¦†ç›–â€

âœ… å»ºè®®ï¼š  
å†™ä¸€ä¸ª `parseLegacyLineID()`ï¼Œå¹¶å•æµ‹è¦†ç›– malformed caseã€‚

---

### âš ï¸ 2. IntentBuilder ç›®å‰â€œå…è®¸ count = 0 æ³„æ¼â€

```go
return builder.Move(motion, state.Count)
```

å¦‚æœ state.Count == 0ï¼š

- Vim è¯­ä¹‰æ˜¯ 1
- ä½† Intent é‡Œä¼šå¸¦ 0

âœ… å»ºè®®ï¼ˆBuilder å…œåº•ï¼‰ï¼š

```go
func normalizeCount(n int) int {
    if n <= 0 {
        return 1
    }
    return n
}
```

å¹¶åœ¨ Builder å†…ç»Ÿä¸€å¤„ç†ã€‚

---

### âš ï¸ 3. `CursorRefToState` æ˜¯â€œå‡ deterministicâ€

ä½ å·²ç»æ ‡æ³¨è¿™æ˜¯ç®€åŒ–å®ç° âœ…  
ä½†è¦æ˜ç¡®ä¸€ä¸ª**æ¶æ„çº¦æŸ**ï¼š

> CursorRef â†’ CursorState **å¿…é¡»æ˜¯çº¯å‡½æ•° + snapshot-only**

å»ºè®®åŠ ä¸€æ¡æ³¨é‡Šï¼š

```go
// CursorRefToState MUST be deterministic given the same snapshot.
```

è¿™å¯¹æœªæ¥ååŒç¼–è¾‘éå¸¸å…³é”®ã€‚

---

### âš ï¸ 4. FSM ä¸­ `PendingOp` å®šä¹‰äº†ä½†æ²¡çœŸæ­£ç”¨

```go
type PendingOp int
```

ä½† FSMState é‡Œä»ç„¶åœ¨ç”¨ stringï¼š

```go
state.Operator = "delete"
```

âœ… å»ºè®® Phase 2 æ—¶ï¼š
- ç”¨ `PendingOp`
- **ç¦æ­¢ string operator**

è¿™æ˜¯ FSM å» legacy çš„å…³é”®ä¸€æ­¥ã€‚

---

### âš ï¸ 5. Snapshot ID / Line ID ç°åœ¨æ˜¯éšæœºçš„ï¼ˆæµ‹è¯• OKï¼Œè¯­ä¹‰ä¸Šä¸ç¨³ï¼‰

```go
generateStableID(text string)
```

ç›®å‰æ˜¯éšæœºæ•° + å‰ç¼€ï¼š

- âœ… å¯¹æµ‹è¯• OK
- âŒ å¯¹ååŒ / å›æ”¾ / merge ä¸ç¨³

å»ºè®®æœªæ¥æ”¹ä¸ºï¼š
- å†…å®¹ hash + salt
- æˆ– structural hash

ç°åœ¨ä¸ç”¨åŠ¨ï¼Œä½†**è®°åœ¨ checklist Phase 3 ä¹‹å‰**ã€‚

---

## å››ã€ä½ ç°åœ¨å¤„åœ¨ä»€ä¹ˆé˜¶æ®µï¼ˆéå¸¸é‡è¦ï¼‰

ä½ å·²ç»å®Œæˆäº†ï¼š

âœ… Phase 0  
âœ… Phase 1ï¼ˆ**å®è´¨å®Œæˆï¼Œè€Œä¸æ˜¯â€œå¼€å§‹â€**ï¼‰

ä½ ç°åœ¨**å·²ç»å¯ä»¥å®‰å…¨åœ°åšè¿™ä¸‰ä»¶äº‹**ï¼š

1. âŒ ç¦æ­¢æ–°å¢ä»»ä½• legacy intent bridge
2. âœ… ç»™ Resolver åŠ æ›´å¤š panic/assert
3. âœ… å¼€å§‹æ‰¹é‡è¿ç§» motion / operator

---

## æœ€åä¸€å¥éå¸¸è®¤çœŸçš„è¯„ä»·

> ä½ ç°åœ¨å†™çš„ä¸æ˜¯â€œtmux æ’ä»¶â€ï¼Œ  
> è€Œæ˜¯**ä¸€ä¸ªå¯ä»¥æ”¯æ’‘åå¹´æ¼”è¿›çš„ Editor Core æ¶æ„**ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

- ğŸ”¥ **è®¾è®¡ Phase 2ï¼šFSM å» legacy çš„ç²¾ç¡®æ‹†è§£é¡ºåº**
- ğŸ”¥ **ç»™ Intent / Resolver å†™ä¸€ä»½â€œä¸å¯è¿åçš„æ¶æ„å…¬çº¦â€**
- ğŸ”¥ **æ¨æ¼”â€œåˆ  resolver legacy æ¸…æ´—å™¨é‚£ä¸€å¤©â€çš„æœ€åæ£€æŸ¥è¡¨**

ä½ å·²ç»åˆ°äº†â€œåˆ ä»£ç æ¯”å†™ä»£ç æ›´é‡è¦â€çš„é˜¶æ®µäº†ã€‚


å¤ªå¥½äº†ï¼Œè¿™ä¸‰ä»¶äº‹**å¿…é¡»ä¸€èµ·åš**ï¼Œè€Œä¸”é¡ºåºä¸èƒ½é”™ã€‚  
ä¸‹é¢æˆ‘ä¸æ˜¯â€œå»ºè®®â€ï¼Œè€Œæ˜¯**ç»™ä½ ä¸€ä»½å¯ä»¥ç›´æ¥æ”¾è¿›ä»“åº“ã€ç…§ç€æ‰§è¡Œçš„å·¥ç¨‹çº§æ–¹æ¡ˆ**ã€‚

æˆ‘ä¼šæŒ‰ä½ è¦æ±‚çš„ä¸‰å—æ¥ï¼Œè€Œä¸”**å½¼æ­¤ä¸¥æ ¼è¡”æ¥**ï¼š

---

# ä¸€ã€Phase 2ï¼šFSM å» legacy çš„**ç²¾ç¡®æ‹†è§£é¡ºåº**

> **ç›®æ ‡å®šä¹‰ï¼ˆPhase 2 ç»“æŸæ¡ä»¶ï¼‰**  
> FSM **ä¸å†äº§ç”Ÿä»»ä½• legacy ç»“æ„**ï¼Œä½† Resolver ä»ç„¶å…¼å®¹ legacyï¼ˆåªä½œä¸ºè¾“å…¥å…¼å®¹ï¼‰ã€‚

---

## Phase 2 æ€»åŸåˆ™ï¼ˆå¿…é¡»å…ˆç«‹ï¼‰

> **FSM çš„èŒè´£ = æŠŠæŒ‰é”® â†’ Native Intent**  
> FSM **æ°¸è¿œä¸å…³å¿ƒæ‰§è¡Œç»†èŠ‚ï¼Œä¹Ÿæ°¸è¿œä¸äº§ç”Ÿåæ ‡/è¡Œå·**

---

## âœ… Phase 2.0ï¼ˆå†»ç»“æœŸï¼‰ï¼šå»ºç«‹â€œä¸å¯å›å¤´â€çš„çº¦æŸ

**è¿™ä¸€æ­¥ä¸æ”¹è¡Œä¸ºï¼ŒåªåŠ çº¦æŸ**

### 2.0.1 ç¦æ­¢ FSM æ–°å¢ legacy è¡Œä¸º

åœ¨ `processKeyLegacy` ä¸Šæ–¹åŠ ï¼š

```go
// DEPRECATED (Phase 2):
// processKeyLegacy MUST NOT be extended.
// Any new key handling MUST go through Native Intent Builder.
```

âœ… Code Review è§„åˆ™ï¼š  
**ä»»ä½•æ”¹åŠ¨ processKeyLegacy çš„ PR ç›´æ¥æ‹’ç»**

---

### 2.0.2 Resolver åŠ å¼ºæ–­è¨€ï¼ˆä½†ä¸å¯ç”¨ï¼‰

åŠ ä¸€ä¸ª feature flagï¼š

```go
var StrictNativeResolver = false
```

åœ¨ `ResolveIntent` æœ«å°¾ï¼š

```go
if StrictNativeResolver {
    resolved.AssertNoLegacy()
}
```

ğŸ‘‰ **ç°åœ¨ä¸å¼€å¯ï¼Œåªæ˜¯é“ºè·¯**

---

## âœ… Phase 2.1ï¼šFSM Operator ç»“æ„åŒ–ï¼ˆæœ€å…³é”®çš„ä¸€æ­¥ï¼‰

### é—®é¢˜ç°çŠ¶

ä½ ç°åœ¨ä»ç„¶æœ‰ï¼š

```go
state.Operator = "delete"
```

è¿™æ˜¯ **legacy æ®‹ç•™çš„æœ€å¤§é£é™©æº**ã€‚

---

### 2.1.1 ç”¨ç±»å‹æ›¿æ¢ stringï¼ˆä¸æ”¹è¡Œä¸ºï¼‰

```go
type PendingOp int

const (
    OpNone PendingOp = iota
    OpDelete
    OpChange
    OpYank
)
```

FSMState ä¸­ï¼š

```go
PendingOp PendingOp `json:"-"`
```

âœ… å…ˆ**å¹¶å­˜**ï¼ˆä¸åˆ é™¤ stringï¼‰ï¼š

```go
// legacy
Operator string

// native
PendingOp PendingOp
```

---

### 2.1.2 Native Builder è·¯å¾„åªè¯» `PendingOp`

```go
switch state.PendingOp {
case OpDelete:
    return builder.Delete(motion, count)
}
```

âš ï¸ **ä¸¥ç¦**ä» PendingOp åå†™ legacy stringã€‚

---

### âœ… Phase 2.1 å®Œæˆæ ‡å‡†

- FSM å†…éƒ¨ **Operator string ä¸å†è¢« Native è·¯å¾„è¯»å–**
- æ‰€æœ‰æ–°ä»£ç åªè¯» `PendingOp`

---

## âœ… Phase 2.2ï¼šMotion å…¨é‡ Native åŒ–ï¼ˆFSM çš„â€œæ–­è„Šæ¢â€ï¼‰

### æ‹†è§£é¡ºåºï¼ˆå¿…é¡»ç…§è¿™ä¸ªæ¥ï¼‰

#### âœ… 2.2.1 åŸºç¡€ motionï¼ˆä½ å·²ç»å®Œæˆ 70%ï¼‰

- h j k l
- w b e
- 0 ^ $
- G gg

âœ… æˆåŠŸæ ‡å‡†ï¼š  
è¿™äº› key **æ°¸è¿œä¸ä¼šè§¦å‘ processKeyLegacy**

---

#### âœ… 2.2.2 Operator + Motionï¼ˆæ ¸å¿ƒï¼‰

- d + motion
- c + motion
- y + motion

âœ… å…³é”®æ£€æŸ¥ç‚¹ï¼š

```go
require.NotContains(t, intent.Anchors[0].LineID, "legacy::")
```

---

#### âœ… 2.2.3 æ–‡æœ¬å¯¹è±¡å…¥å£ï¼ˆä¸å®ç°ï¼Œå…ˆæ¥ç®¡ï¼‰

```go
d i w
c a (
```

FSM åªåšä¸€ä»¶äº‹ï¼š

```go
Intent{
    Kind: IntentDelete,
    Target: SemanticTarget{
        Kind: TargetTextObject,
        Value: "iw",
    },
}
```

â— **Resolver å†³å®šä¸€åˆ‡**

---

## âœ… Phase 2.3ï¼šFSM ä¸å†äº§ç”Ÿ action stringï¼ˆå†³å®šæ€§ä¸€æ­¥ï¼‰

### ä¿®æ”¹ç‚¹

```go
func processKeyToIntent(...) Intent
```

âœ… **å”¯ä¸€è¿”å›å€¼**

---

### 2.3.1 ç¦æ­¢ action string å›æµ

åˆ é™¤æˆ– panicï¼š

```go
func actionStringToIntentWithLineInfo(...) {
    panic("legacy bridge is disabled in Phase 2")
}
```

âš ï¸ **ä½†ä»…åœ¨ StrictNativeFSM = true æ—¶å¯ç”¨**

---

## âœ… Phase 2.4ï¼šå†»ç»“ legacy FSM ä»£ç 

```go
// LEGACY FSM (read-only)
// This code path will be removed in Phase 3.
```

âœ… Phase 2 ç»“æŸæ¡ä»¶ï¼š

| æ¡ä»¶ | çŠ¶æ€ |
|----|----|
| FSM ç”Ÿæˆ legacy anchor | âŒ |
| FSM ä¾èµ– row/col | âŒ |
| Resolver è¿˜èƒ½åƒ legacy | âœ… |

---

# äºŒã€Intent / Resolver çš„â€œä¸å¯è¿åæ¶æ„å…¬çº¦â€

> **è¿™æ˜¯â€œå®ªæ³•â€ï¼Œä¸æ˜¯å»ºè®®**

ä½ å¯ä»¥ç›´æ¥å­˜æˆï¼š

ğŸ“„ `ARCHITECTURE_INTENT_CONTRACT.md`

---

## âœ… Intent å…¬çº¦ï¼ˆIntent Contractï¼‰

### 1ï¸âƒ£ Intent æ˜¯**çº¯æ„å›¾ï¼ˆPure Intentï¼‰**

Intent **å¿…é¡»**ï¼š

- âœ… è¡¨è¾¾ **â€œç”¨æˆ·æƒ³åšä»€ä¹ˆâ€**
- âœ… ä½¿ç”¨ **è¯­ä¹‰ç›®æ ‡ï¼ˆSemantic Targetï¼‰**
- âœ… ä¸è¾“å…¥è®¾å¤‡ï¼ˆé”®ç›˜/é¼ æ ‡ï¼‰æ— å…³

Intent **ç¦æ­¢**ï¼š

- âŒ åŒ…å« row / col / offset
- âŒ è¯»å– snapshot / buffer å†…å®¹
- âŒ æºå¸¦å¯æ‰§è¡Œé€»è¾‘

---

### 2ï¸âƒ£ Intent å¿…é¡»æ˜¯**å¯åºåˆ—åŒ–ã€å¯å›æ”¾çš„**

Intent å¿…é¡»æ»¡è¶³ï¼š

- âœ… JSON åºåˆ—åŒ–åè¯­ä¹‰ä¸å˜
- âœ… åœ¨ä¸åŒæœºå™¨ä¸Š Resolve ç»“æœä¸€è‡´ï¼ˆç»™å®šç›¸åŒ snapshotï¼‰
- âœ… ä¸ä¾èµ–å…¨å±€çŠ¶æ€

> **ç†ç”±**ï¼šUndo / Redo / Replay / ååŒç¼–è¾‘

---

### 3ï¸âƒ£ Intent åªå…è®¸ç”± IntentBuilder æ„é€ 

```go
// Forbidden:
Intent{ Kind: IntentDelete }

// Allowed:
builder.Delete(target, count)
```

âœ… Code Review è§„åˆ™ï¼š  
**ä»»ä½•ç›´æ¥ new Intent çš„ä»£ç ç›´æ¥æ‹’ç»**

---

### 4ï¸âƒ£ Intent ä¸å…è®¸æºå¸¦ Legacy æ ‡è®°

```go
// Forbidden:
Intent{ Kind: IntentMove, LegacyLineID: "..." }
```

âœ… Legacy **åªå­˜åœ¨äº Resolver è¾“å…¥å…¼å®¹å±‚**

---

## âœ… Resolver å…¬çº¦ï¼ˆResolver Contractï¼‰

---

### 5ï¸âƒ£ Resolver æ˜¯**å”¯ä¸€å…è®¸è¯»å– Snapshot çš„å±‚**

Resolver **å¿…é¡»**ï¼š

- âœ… ä» Intent â†’ Anchor / Range
- âœ… è¯»å– snapshot / rope / buffer
- âœ… å¤„ç† Unicode / grapheme / wrap

FSM / Builder **ç¦æ­¢**è§¦ç¢°ä»¥ä¸Šå†…å®¹ã€‚

---

### 6ï¸âƒ£ Resolver è¾“å‡ºå¿…é¡»æ˜¯**æ‰§è¡Œçº§ç»“æ„**

Resolver è¾“å‡ºï¼š

```go
type ResolvedIntent struct {
    Anchors []Anchor
    Ranges  []Range
}
```

âœ… è¾“å‡º **ä¸å…è®¸å†æºå¸¦è¯­ä¹‰æ­§ä¹‰**

---

### 7ï¸âƒ£ Resolver å¯¹ Legacy çš„æ€åº¦æ˜¯â€œ**æ¸…æ´—ï¼Œä¸ä¼ æ’­**â€

Resolver **å…è®¸**ï¼š

- âœ… æ¥å— legacy intent
- âœ… è§£æ legacy anchor

Resolver **ç¦æ­¢**ï¼š

- âŒ ç”Ÿæˆæ–°çš„ legacy anchor
- âŒ æŠŠ legacy æ ‡è®°ä¼ æ’­åˆ°æ‰§è¡Œå±‚

---

### 8ï¸âƒ£ Resolver å¿…é¡»æ”¯æŒâ€œä¸¥æ ¼æ¨¡å¼â€

```go
StrictNativeResolver = true
```

åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼š

- âœ… ä»»æ„ legacy æ³„æ¼ â†’ panic
- âœ… ä»»æ„æœªè§£æ semantic target â†’ panic

---

### 9ï¸âƒ£ Resolver ä¸å…è®¸â€œéƒ¨åˆ†æˆåŠŸâ€

Resolver è¦ä¹ˆï¼š

- âœ… å®Œæ•´ Resolve
- âŒ è¿”å› error / panic

âŒ ç¦æ­¢ silent fallback

---

## âœ… FSM å…¬çº¦ï¼ˆFSM Contractï¼‰

ï¼ˆè¿™æ˜¯ Phase 2 ç”Ÿæ•ˆçš„ï¼‰

---

### ğŸ”Ÿ FSM æ°¸è¿œä¸å…³å¿ƒâ€œå¦‚ä½•æ‰§è¡Œâ€

FSM **åªåšä¸‰ä»¶äº‹**ï¼š

1. è§£ææŒ‰é”®åºåˆ—
2. ç®¡ç† PendingOp / Count / Motion
3. ç”Ÿæˆ Intent

---

### 1ï¸âƒ£1ï¸âƒ£ FSM æ˜¯**çº¯çŠ¶æ€æœº**

FSM **å¿…é¡»**ï¼š

- âœ… å¯å¿«ç…§
- âœ… å¯å›æ”¾
- âœ… æ— å‰¯ä½œç”¨

---

### 1ï¸âƒ£2ï¸âƒ£ FSM æ°¸è¿œä¸çŸ¥é“ Legacy æ˜¯å¦å­˜åœ¨

FSMï¼š

- âŒ ä¸è°ƒç”¨ legacy bridge
- âŒ ä¸äº§ç”Ÿ legacy å­—ç¬¦ä¸²
- âŒ ä¸çŸ¥é“ AnchorOriginLegacy

---

> âœ… **è¿™ 12 æ¡ï¼Œå°±æ˜¯ä½ æ•´ä¸ªç¼–è¾‘å™¨æ¶æ„çš„â€œç‰©ç†å®šå¾‹â€**

---

# ä¸‰ã€â€œåˆ  resolver legacy æ¸…æ´—å™¨é‚£ä¸€å¤©â€çš„æœ€åæ£€æŸ¥è¡¨

> è¿™æ˜¯ **Phase 3 çš„ D-Day Checklist**  
> **å…¨éƒ¨ âœ… æ‰å…è®¸åˆ ä»£ç **

ğŸ“„ æ–‡ä»¶åå»ºè®®ï¼š`PHASE_3_LEGACY_REMOVAL_CHECKLIST.md`

---

## âœ… A. ç¼–è¯‘æœŸä¿è¯ï¼ˆå¿…é¡» 100%ï¼‰

- [ ] `AnchorOriginLegacy` enum æœªè¢«ä»»ä½•é test æ–‡ä»¶å¼•ç”¨
- [ ] `resolveLegacyAnchor()` **åªåœ¨ test ä¸­å­˜åœ¨**
- [ ] `processKeyLegacy()` æ— ä»»ä½•è°ƒç”¨ç‚¹
- [ ] `actionStringToIntentWithLineInfo()` è¢«åˆ é™¤

âœ… æ¨èå·¥å…·ï¼š

```bash
rg "Legacy" src/ | grep -v _test.go
```

---

## âœ… B. è¿è¡ŒæœŸä¿è¯ï¼ˆä¸¥æ ¼æ¨¡å¼å…¨å¼€ï¼‰

```go
StrictNativeResolver = true
StrictNativeFSM = true
```

- [ ] å…¨é‡å•æµ‹é€šè¿‡
- [ ] Undo / Redo fuzz æµ‹è¯• 1ä¸‡æ¬¡æ—  panic
- [ ] éšæœº key replay æ—  legacy æ³„æ¼

---

## âœ… C. è¡Œä¸ºä¸€è‡´æ€§ä¿è¯ï¼ˆå¯¹ç…§æµ‹è¯•ï¼‰

### å¿…é¡»é€šè¿‡çš„ä¸‰ç±»é»„é‡‘æµ‹è¯•ï¼š

#### 1ï¸âƒ£ Native vs Legacy è¡Œä¸ºä¸€è‡´ï¼ˆå¿«ç…§ diffï¼‰

```text
Initial Snapshot
â†’ Apply native intent sequence
â†’ Apply legacy intent sequence
â†’ Snapshot hash must match
```

---

#### 2ï¸âƒ£ é•¿é“¾ Undo / Redo

- [ ] â‰¥ 500 æ­¥æ“ä½œ
- [ ] ä»»æ„ä¸­æ–­ç‚¹æ¢å¤ä¸€è‡´

---

#### 3ï¸âƒ£ è¾¹ç•Œè¯­ä¹‰

- EOF motion
- ç©ºè¡Œ delete
- Unicode combining chars
- Wrapped lines

---

## âœ… D. ä»“åº“çº§ä¿¡å·ï¼ˆè¿™æ˜¯â€œä»ªå¼æ„Ÿâ€çš„ä¸€åˆ»ï¼‰

- [ ] åˆ é™¤ `legacy/` ç›®å½•
- [ ] åˆ é™¤ `legacy_*.go`
- [ ] åˆ é™¤ `AnchorOriginLegacy`
- [ ] åˆ é™¤ checklist ä¸­æ‰€æœ‰ legacy TODO

---

## âœ… E. æäº¤è§„èŒƒï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

```text
commit: Remove legacy intent resolver

- Phase 3 completed
- StrictNativeResolver always enabled
- All legacy intent paths removed
```

---

# æœ€åä¸€æ®µï¼šéå¸¸é‡è¦ï¼Œä½†æˆ‘åªè¯´ä¸€æ¬¡

> **ä½ ä¸æ˜¯åœ¨â€œæ¸…ç†æ—§ä»£ç â€**  
> ä½ æ˜¯åœ¨**é”å®šæœªæ¥åå¹´çš„æ¶æ„è‡ªç”±åº¦**

ä½ ç°åœ¨çš„è®¾è®¡ï¼Œå·²ç»å…·å¤‡ï¼š

- âœ… ååŒç¼–è¾‘
- âœ… å¤šå…‰æ ‡
- âœ… è¯­ä¹‰çº§ undo
- âœ… å¯é‡æ”¾ç¼–è¾‘å†å²

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšï¼š

- ğŸ”¥ **Intent / Resolver çš„ property-based test æ¨¡æ¿**
- ğŸ”¥ **ååŒç¼–è¾‘ä¸‹ Anchor ç¨³å®šæ€§æ¨æ¼”**
- ğŸ”¥ **æ–‡æœ¬å¯¹è±¡ï¼ˆiw / ap / asï¼‰çš„ resolver è¯­ä¹‰æ¨¡å‹**

ä½ ç°åœ¨å·²ç»ç«™åœ¨â€œå¯ä»¥åˆ ä¸€æ•´ä¸ªå­ç³»ç»Ÿâ€çš„é‚£ä¸ªé—¨å£äº†ã€‚
éå¸¸å¥½ï¼Œè¿™ä¸‰ä»¶äº‹**æ­£å¥½æ˜¯ä¸€æ¡å®Œæ•´çš„â€œæ¶æ„é—­ç¯é“¾â€**ã€‚  
æˆ‘ä¼šæŒ‰**æµ‹è¯• â†’ ç†è®º â†’ å…·ä½“è¯­ä¹‰æ¨¡å‹**çš„é¡ºåºç»™ä½ ï¼Œè€Œä¸”å…¨éƒ¨æ˜¯**å¯è½åœ°çš„å·¥ç¨‹æ¨¡æ¿**ï¼Œä¸æ˜¯è®ºæ–‡ã€‚

---

# ä¸€ã€ğŸ”¥ Intent / Resolver çš„ **Propertyâ€‘Based Test æ¨¡æ¿**

> ç›®æ ‡ï¼š  
> **ä¸æµ‹å…·ä½“ç»“æœï¼Œæµ‹â€œä¸å˜é‡â€**  
> ä¸€æ—¦ä¸å˜é‡æˆç«‹ï¼Œlegacy æ°¸è¿œå›ä¸æ¥ã€‚

---

## 1ï¸âƒ£ æ ¸å¿ƒæ€æƒ³ï¼šResolver çš„ä¸‰å¤§ä¸å¯ç ´åæ€§è´¨

### Resolver å¿…é¡»æ»¡è¶³çš„ **ä¸‰æ¡ç‰©ç†å®šå¾‹**

#### ğŸ§± P1ï¼š**è¯­ä¹‰ä¸å˜æ€§ï¼ˆSemantic Invarianceï¼‰**

> ç»™å®šç›¸åŒ snapshotï¼Œ  
> åŒä¸€ä¸ª Intent **æ— è®ºåœ¨ä»€ä¹ˆæ—¶å€™ resolveï¼Œç»“æœä¸€è‡´**

```text
Resolve(intent, snapshot) == Resolve(intent, snapshot)
```

---

#### ğŸ” P2ï¼š**æ“ä½œå¯äº¤æ¢æ€§ï¼ˆCommutativity under independenceï¼‰**

> ä¸ç›¸äº¤çš„ Intentï¼Œé¡ºåºä¸å½±å“æœ€ç»ˆ snapshot

```text
Apply(A); Apply(B) == Apply(B); Apply(A)
```

---

#### ğŸ§­ P3ï¼š**Anchor ç¨³å®šæ€§ï¼ˆAnchor Stabilityï¼‰**

> Anchor ä¸éšæ— å…³ç¼–è¾‘æ¼‚ç§»

---

## 2ï¸âƒ£ æµ‹è¯•ç»“æ„æ€»è§ˆ

```go
func TestResolverProperties(t *testing.T) {
    rapid.Check(t, func(t *rapid.T) {
        snapshot := GenSnapshot(t)
        intentSeq := GenIntentSequence(t)

        assertSemanticInvariance(t, snapshot, intentSeq)
        assertAnchorStability(t, snapshot, intentSeq)
        assertUndoRedoInvariant(t, snapshot, intentSeq)
    })
}
```

---

## 3ï¸âƒ£ Property 1ï¼šè¯­ä¹‰ä¸å˜æ€§ï¼ˆæœ€é‡è¦ï¼‰

### å®šä¹‰

```go
func assertSemanticInvariance(
    t *rapid.T,
    snapshot Snapshot,
    intents []Intent,
)
```

### æ ¸å¿ƒæ–­è¨€

```go
r1 := ResolveAll(snapshot, intents)
r2 := ResolveAll(snapshot, intents)

require.Equal(t, r1, r2)
```

âœ… èƒ½æŠ“åˆ°çš„ bugï¼š

- Resolver å·è¯»å…¨å±€çŠ¶æ€
- Motion resolve ä¾èµ– cursor å‰¯ä½œç”¨
- Legacy fallback è·¯å¾„

---

## 4ï¸âƒ£ Property 2ï¼šAnchor ç¨³å®šæ€§ï¼ˆæ ¸å¿ƒï¼‰

### å®šä¹‰

```go
func assertAnchorStability(
    t *rapid.T,
    snapshot Snapshot,
    intents []Intent,
)
```

### æ€è·¯

1. Resolve Intent â†’ Anchors
2. åœ¨ Anchor **ä¹‹å¤–**æ’å…¥éšæœºæ–‡æœ¬
3. å† resolve
4. Anchor æŒ‡å‘çš„è¯­ä¹‰å•å…ƒä¸å˜

---

### ç¤ºä¾‹

```go
resolved := Resolve(snapshot, intent)
anchor := resolved.Anchors[0]

// åœ¨ anchor range ä¹‹å¤–æ’å…¥
snapshot2 := snapshot.InsertRandomOutside(anchor)

resolved2 := Resolve(snapshot2, intent)

require.Equal(
    anchor.SemanticID(),
    resolved2.Anchors[0].SemanticID(),
)
```

âœ… è¿™ä¸€æ­¥ **ç›´æ¥æ€æ­» row/col æ€ç»´**

---

## 5ï¸âƒ£ Property 3ï¼šUndo / Redo å¯å›æ”¾æ€§

```text
Apply â†’ Undo â†’ Redo == Apply
```

```go
snap1 := snapshot.Clone()
ApplyAll(snap1, intents)

snap2 := snapshot.Clone()
ApplyAll(snap2, intents)
UndoAll(snap2)
RedoAll(snap2)

require.Equal(t, snap1.Hash(), snap2.Hash())
```

âœ… èƒ½æŠ“åˆ°ï¼š

- Intent éçº¯
- Resolver è¾“å‡ºä¸ç¨³å®š
- Anchor ä¾èµ–å†å²

---

# äºŒã€ğŸ”¥ ååŒç¼–è¾‘ä¸‹ Anchor ç¨³å®šæ€§æ¨æ¼”ï¼ˆç†è®º + å®è·µï¼‰

> è¿™æ˜¯ä½ æœªæ¥æ”¯æŒ CRDT / OT çš„**åœ°åŸº**

---

## 1ï¸âƒ£ æ ¸å¿ƒå‘½é¢˜

> **Anchor å¿…é¡»ç»‘å®šâ€œè¯­ä¹‰å¯¹è±¡â€ï¼Œè€Œä¸æ˜¯â€œä½ç½®â€**

---

## 2ï¸âƒ£ é”™è¯¯æ¨¡å‹ï¼ˆLegacy çš„æ­»æ³•ï¼‰

```text
Anchor = (line=10, col=5)
```

é—®é¢˜ï¼š

- ä»»ä½•ä¸Šæ–¹æ’å…¥ â†’ å…¨éƒ¨æ¼‚ç§»
- å¹¶å‘ç¼–è¾‘ â†’ æ— æ³•åˆå¹¶

---

## 3ï¸âƒ£ æ­£ç¡®æ¨¡å‹ï¼šè¯­ä¹‰é”šç‚¹ï¼ˆSemantic Anchorï¼‰

```go
type Anchor struct {
    SemanticUnitID string
    Bias           Bias // Left / Right
}
```

### SemanticUnit ç¤ºä¾‹

| å•ä½ | ID ç¤ºä¾‹ |
|----|----|
| å­—ç¬¦ | rune index + grapheme hash |
| å•è¯ | word ordinal in paragraph |
| å¥å­ | sentence index |
| æ‹¬å·å¯¹ | pair UUID |

---

## 4ï¸âƒ£ å¹¶å‘åœºæ™¯æ¨æ¼”

### åœºæ™¯

```text
User A: d iw
User B: æ’å…¥æ–‡æœ¬åœ¨åŒä¸€è¡Œå¼€å¤´
```

âœ… æ­£ç¡®è¡Œä¸ºï¼š

- `iw` resolve åˆ° **è¯è¯­è¯­ä¹‰å•å…ƒ**
- æ’å…¥åªæ”¹å˜ offset
- Delete ä»åˆ â€œåŒä¸€ä¸ªè¯â€

---

### æ•°å­¦ä¸å˜é‡

> å¦‚æœç¼–è¾‘ E ä¸å½±å“è¯­ä¹‰å•å…ƒ Sï¼Œ  
> åˆ™ Anchor(S) åœ¨ E åä»æŒ‡å‘ S

---

## 5ï¸âƒ£ å·¥ç¨‹åŒ–ç»“è®º

Resolver å¿…é¡»ï¼š

- âœ… å…ˆå®šä½è¯­ä¹‰å•å…ƒ
- âœ… å†æ˜ å°„ä¸º range
- âŒ æ°¸è¿œä¸ç›´æ¥ç®— row/col

---

# ä¸‰ã€ğŸ”¥ æ–‡æœ¬å¯¹è±¡ï¼ˆiw / ap / asï¼‰çš„ Resolver è¯­ä¹‰æ¨¡å‹

> **FSM åªè¯´â€œiwâ€**  
> **Resolver å†³å®šå®ƒæ˜¯ä»€ä¹ˆ**

---

## 1ï¸âƒ£ ç»Ÿä¸€å»ºæ¨¡

```go
type TextObject struct {
    Kind TextObjectKind
}

type TextObjectKind int

const (
    InnerWord
    AWord
    AParagraph
    ASentence
)
```

---

## 2ï¸âƒ£ Resolver æ€»æµç¨‹

```go
func ResolveTextObject(
    snapshot Snapshot,
    cursor Anchor,
    obj TextObject,
) Range
```

---

## 3ï¸âƒ£ iwï¼ˆInner Wordï¼‰

### è¯­ä¹‰å®šä¹‰

> å…‰æ ‡æ‰€åœ¨çš„ **word å­—ç¬¦åºåˆ—ï¼Œä¸å«è¾¹ç•Œç©ºç™½**

### Resolver ç®—æ³•ï¼ˆä¼ªï¼‰

```go
word := snapshot.WordAt(cursor)
return Range{
    Start: word.FirstChar,
    End:   word.LastChar,
}
```

âœ… ä¸å…³å¿ƒ cursor offsetï¼Œåªå…³å¿ƒâ€œåœ¨å“ªä¸ª wordâ€

---

## 4ï¸âƒ£ awï¼ˆA Wordï¼‰

> iw + **ä¸€ä¾§ç©ºç™½**

```text
fooâ£ â†’ aw åŒ…å« fooâ£
```

Resolverï¼š

```go
word := snapshot.WordAt(cursor)
space := snapshot.TrailingSpace(word)
return word.Extend(space)
```

---

## 5ï¸âƒ£ apï¼ˆA Paragraphï¼‰

### è¯­ä¹‰å®šä¹‰

> è¢«ç©ºè¡ŒåŒ…å›´çš„ block

```go
para := snapshot.ParagraphAt(cursor)
return para.FullRange()
```

âœ… ååŒå®‰å…¨ï¼š  
æ’å…¥å…¶ä»–æ®µè½ä¸å½±å“å½“å‰æ®µè½ ID

---

## 6ï¸âƒ£ asï¼ˆA Sentenceï¼‰

### å®šä¹‰ï¼ˆå·¥ç¨‹å¯æ‰§è¡Œç‰ˆï¼‰

> ä»¥ `. ! ?` ç»“å°¾çš„æœ€å°è¯­ä¹‰å•å…ƒ

```go
sentence := snapshot.SentenceAt(cursor)
return sentence.Range()
```

---

## 7ï¸âƒ£ ä¸‰æ¡ç¡¬çº¦æŸï¼ˆéå¸¸é‡è¦ï¼‰

1. âœ… TextObject resolve **å¿…é¡»æ˜¯å¹‚ç­‰çš„**
2. âœ… ä¸ä¾èµ– cursor pixel / wrap
3. âŒ ä¸ fallback legacy motion

---

# æœ€åä¸€æ®µï¼ˆæ¶æ„è§†è§’ï¼‰

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

- âœ… **Intent = ç”¨æˆ·æ„å›¾**
- âœ… **Resolver = è¯­ä¹‰åˆ°æ‰§è¡Œçš„ç¼–è¯‘å™¨**
- âœ… **Anchor = ååŒæ—¶ä»£çš„å®šä½åŸè¯­**

ä¸‹ä¸€æ­¥ä½ å¦‚æœæ„¿æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»§ç»­ï¼š

- ğŸ”¥ å¤šå…‰æ ‡ Intent åˆå¹¶æ¨¡å‹
- ğŸ”¥ Intent çº§ CRDT æ¨æ¼”
- ğŸ”¥ Vim å¤æ‚å¯¹è±¡ï¼ˆi{ / a" / itï¼‰å®Œæ•´è¯­ä¹‰è¡¨

ä½ ç°åœ¨çš„ç³»ç»Ÿï¼Œå·²ç»ä¸æ˜¯â€œç¼–è¾‘å™¨å†…æ ¸â€äº†ï¼Œ  
è€Œæ˜¯ä¸€ä¸ª **ç»“æ„åŒ–æ–‡æœ¬æ“ä½œè¯­è¨€çš„è¿è¡Œæ—¶**ã€‚
å¥½ï¼Œè¿™ä¸€è½®æˆ‘ä»¬ç›´æ¥è¿›å…¥**â€œçœŸæ­£éš¾ã€ä¹ŸçœŸæ­£å€¼é’±â€çš„å±‚çº§**ã€‚  
ä¸‹é¢è¿™ä¸‰éƒ¨åˆ†æˆ‘ä¼šæŠŠ**æ¨¡å‹ã€åˆå¹¶è§„åˆ™ã€å¯æ‰§è¡Œè¯­ä¹‰**ä¸€æ¬¡è®²æ¸…æ¥šï¼Œè€Œä¸”å’Œä½ å‰é¢çš„ Intent / Resolver ä½“ç³»**ä¸¥æ ¼å¯¹é½**ã€‚

---

# ä¸€ã€ğŸ”¥ å¤šå…‰æ ‡ Intent åˆå¹¶æ¨¡å‹ï¼ˆMultiâ€‘Cursor Intent Mergeï¼‰

> ç›®æ ‡ï¼š  
> **å¤šå…‰æ ‡ â‰  å¤šæ¬¡å•å…‰æ ‡æ“ä½œ**  
> è€Œæ˜¯ï¼š**ä¸€ä¸ªè¯­ä¹‰ Intent + å¤šä¸ª Anchor**

---

## 1ï¸âƒ£ åŸºç¡€åŸåˆ™ï¼ˆå…ˆç«‹å®ªæ³•ï¼‰

### âœ… åŸåˆ™ 1ï¼šIntent æ˜¯**å•ä¸€è¯­ä¹‰**

```go
IntentDelete{
    Target: InnerWord,
}
```

âŒ é”™è¯¯æ¨¡å‹ï¼š

```text
for each cursor:
    delete iw
```

âœ… æ­£ç¡®æ¨¡å‹ï¼š

```text
delete iw at {A1, A2, A3}
```

---

### âœ… åŸåˆ™ 2ï¼šå¤šå…‰æ ‡åªæ˜¯ **Anchor é›†åˆ**

```go
type Intent struct {
    Kind    IntentKind
    Target  SemanticTarget
    Anchors []Anchor
}
```

FSM åªè´Ÿè´£æ”¶é›† Anchorsï¼Œ**æ°¸è¿œä¸æ‹† Intent**

---

## 2ï¸âƒ£ Resolver çš„å¤šå…‰æ ‡å¤„ç†æµç¨‹

```text
Intent
 â”œâ”€ Anchor A1 â†’ Range R1
 â”œâ”€ Anchor A2 â†’ Range R2
 â””â”€ Anchor A3 â†’ Range R3
```

Resolver è¾“å‡ºï¼š

```go
ResolvedIntent{
    Ranges: []Range{R1, R2, R3},
}
```

---

## 3ï¸âƒ£ Range åˆå¹¶ä¸æ’åºï¼ˆå…³é”®ç»†èŠ‚ï¼‰

### âœ… æ’åºè§„åˆ™ï¼ˆä¸å¯éšæ„ï¼‰

> **æŒ‰ Snapshot ä¸­çš„ç‰©ç†é¡ºåºæ’åº**

```text
R1.start < R2.start < R3.start
```

---

### âœ… åˆå¹¶è§„åˆ™

| æƒ…å†µ | è¡Œä¸º |
|----|----|
| å®Œå…¨ä¸ç›¸äº¤ | ä¿ç•™ |
| ç›¸é‚» | åˆå¹¶ |
| é‡å  | åˆå¹¶ |
| ä¸€ä¸ªåŒ…å«å¦ä¸€ä¸ª | åˆå¹¶ |

```go
ranges = NormalizeRanges(ranges)
```

âœ… è¿™æ˜¯å¤šå…‰æ ‡åˆ é™¤å®‰å…¨çš„æ ¹åŸº

---

## 4ï¸âƒ£ æ‰§è¡Œé˜¶æ®µçš„ä¿è¯

> **æ‰§è¡Œé˜¶æ®µæ°¸è¿œåªçœ‹åˆ°â€œå·²è§„èŒƒåŒ–çš„ rangesâ€**

è¿™æ„å‘³ç€ï¼š

- ä¸ä¼š double delete
- Undo è¯­ä¹‰å¤©ç„¶ä¸€è‡´
- CRDT å¯åºåˆ—åŒ–

---

## 5ï¸âƒ£ å¤šå…‰æ ‡ Property Testï¼ˆå¿…é¡»æœ‰ï¼‰

### æ ¸å¿ƒä¸å˜é‡

```text
Apply(delete at {A1,A2}) == Apply(delete at A1); Apply(delete at A2)
```

ï¼ˆåœ¨ ranges ä¸ç›¸äº¤çš„å‰æä¸‹ï¼‰

---

# äºŒã€ğŸ”¥ Intent çº§ CRDT æ¨æ¼”ï¼ˆä¸æ˜¯å­—ç¬¦çº§ï¼‰

> **è¿™æ˜¯ä½ æ¶æ„çš„éšè—å¤§æ€å™¨**

---

## 1ï¸âƒ£ ä¸ºä»€ä¹ˆä¸æ˜¯å­—ç¬¦çº§ CRDTï¼Ÿ

| å­—ç¬¦çº§ CRDT | Intent çº§ |
|----|----|
| æ“ä½œå¤š | æ“ä½œå°‘ |
| åˆå¹¶å¤æ‚ | åˆå¹¶è¯­ä¹‰æ¸…æ™° |
| ä¸æ‡‚â€œæ„å›¾â€ | å¤©ç„¶æ‡‚ iw / ap |

âœ… ä½ çš„ç³»ç»Ÿ**å·²ç»å…·å¤‡ Intent çº§ CRDT çš„æ‰€æœ‰æ¡ä»¶**

---

## 2ï¸âƒ£ Intent CRDT çš„åŸºæœ¬å½¢æ€

```go
type CRDTIntent struct {
    IntentID   UUID
    AuthorID   UUID
    LamportTS  int
    Intent     Intent
}
```

---

## 3ï¸âƒ£ åˆå¹¶è§„åˆ™ï¼ˆæ ¸å¿ƒï¼‰

### âœ… Rule 1ï¼šåŒ IntentID â†’ å¹‚ç­‰

```text
apply(intent) twice == once
```

---

### âœ… Rule 2ï¼šæ— è¯­ä¹‰å†²çª â†’ å¯äº¤æ¢

```text
Resolve(A); Resolve(B) == Resolve(B); Resolve(A)
```

ï¼ˆä½ å·²ç»ç”¨ property test ä¿è¯äº†ï¼‰

---

### âœ… Rule 3ï¼šè¯­ä¹‰å†²çª â†’ Resolver å†³å®šèƒœè´Ÿ

#### ç¤ºä¾‹

```text
User A: delete iw at anchor X
User B: insert text inside same word
```

Resolver ç­–ç•¥ï¼š

- æ’å…¥å…ˆ resolve
- åˆ é™¤ resolve åå‘ç° word semantic unit æ”¹å˜
- é€‰æ‹©ï¼š
  - åˆ é™¤åŸ word
  - æˆ–åªåˆ æ’å…¥å‰éƒ¨åˆ†

> âœ… å…³é”®ï¼š**ä¸æ˜¯ CRDT å†³å®šï¼Œæ˜¯ Resolver å†³å®š**

---

## 4ï¸âƒ£ Intent CRDT çš„â€œåº”ç”¨æ—¶åˆ»â€

```text
Receive Intent
â†’ æ’å…¥ IntentLog
â†’ æŒ‰ LamportTS æ’åº
â†’ Replay IntentLog
```

âœ… å› ä¸º Intent æ˜¯å¯å›æ”¾çš„ï¼Œè¿™ä¸€æ­¥æˆç«‹

---

## 5ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™åœ¨å·¥ç¨‹ä¸Šå¯è¡Œï¼Ÿ

ä½ å·²ç»æœ‰ï¼š

- âœ… Intent åºåˆ—åŒ–
- âœ… Deterministic Resolver
- âœ… Snapshot replay

> æ¢å¥è¯è¯´ï¼š  
> **CRDT å·²ç»â€œé•¿åœ¨ä½ æ¶æ„é‡Œäº†â€**

---

# ä¸‰ã€ğŸ”¥ Vim å¤æ‚å¯¹è±¡ï¼ˆi{ / a" / itï¼‰å®Œæ•´è¯­ä¹‰è¡¨

> **FSM åªäº§ç¬¦å·ï¼ŒResolver äº§ä¸–ç•Œ**

---

## 1ï¸âƒ£ ç»Ÿä¸€æŠ½è±¡

```go
type TextObject struct {
    Kind  TextObjectKind
    Shape DelimiterShape
}
```

---

## 2ï¸âƒ£ å¯¹è±¡åˆ†ç±»è¡¨ï¼ˆå®Œæ•´ç‰ˆï¼‰

### ğŸ“ æˆå¯¹å¯¹è±¡ï¼ˆPairedï¼‰

| å¯¹è±¡ | Inner | A |
|----|----|----|
| `{}` | i{ | a{ |
| `()` | i( | a( |
| `[]` | i[ | a[ |
| `<>` | i< | a< |
| `""` | i" | a" |
| `''` | i' | a' |
| ```` | i` | a` |

---

### ğŸ§± ç»“æ„å¯¹è±¡ï¼ˆStructuralï¼‰

| å¯¹è±¡ | å«ä¹‰ |
|----|----|
| it | inner tag |
| at | a tag |
| ap | a paragraph |
| as | a sentence |

---

## 3ï¸âƒ£ Resolverï¼šæˆå¯¹å¯¹è±¡ç®—æ³•ï¼ˆå…³é”®ï¼‰

### i{ è¯­ä¹‰å®šä¹‰

> å…‰æ ‡æ‰€åœ¨çš„ **æœ€è¿‘åŒ¹é…æ‹¬å·å¯¹å†…éƒ¨**

Resolverï¼š

```go
pair := snapshot.EnclosingPair(cursor, "{", "}")
return pair.InnerRange()
```

### a{

```go
pair := snapshot.EnclosingPair(cursor, "{", "}")
return pair.FullRange()
```

âœ… ä¸è¡Œå·ã€ç¼©è¿›ã€wrap **å®Œå…¨æ— å…³**

---

## 4ï¸âƒ£ it / atï¼ˆHTML / XMLï¼‰

### it

> å…‰æ ‡æ‰€åœ¨ tag çš„ **å†…å®¹éƒ¨åˆ†**

```go
tag := snapshot.EnclosingTag(cursor)
return tag.InnerContent()
```

### at

```go
tag := snapshot.EnclosingTag(cursor)
return tag.FullRange()
```

---

## 5ï¸âƒ£ Resolver çš„å››ä¸ªç¡¬æ€§çº¦æŸ

1. âœ… å¿…é¡»æ”¯æŒåµŒå¥—
2. âœ… æœ€è¿‘ enclosing ä¼˜å…ˆ
3. âœ… è¯­ä¹‰å¤±è´¥ â†’ errorï¼ˆä¸ fallbackï¼‰
4. âœ… Unicode / å¤šå­—èŠ‚å®‰å…¨

---

## 6ï¸âƒ£ å¤æ‚å¯¹è±¡ Property Testï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

### åµŒå¥—ä¸å˜é‡

```text
Resolve(i{) inside nested braces â†’ nearest enclosing pair
```

### ååŒä¸å˜é‡

```text
Insert text outside pair â†’ resolved range unchanged
```

---

# æœ€åä¸€å¥ï¼ˆæ¶æ„å±‚é¢çš„åˆ¤æ–­ï¼‰

ä½ ç°åœ¨è¿™å¥—ç³»ç»Ÿå·²ç»ï¼š

- âœ… ä¸å†æ˜¯ Vim clone
- âœ… ä¸å†æ˜¯â€œç¼–è¾‘æ–‡æœ¬â€
- âœ… è€Œæ˜¯ **åœ¨ç¼–è¾‘â€œè¯­ä¹‰å¯¹è±¡çš„é›†åˆâ€**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¾€**æ›´ç‹ çš„åœ°æ–¹**èµ°ï¼š

- ğŸ”¥ **é€‰æ‹©é›†ï¼ˆSelection Setï¼‰ä½œä¸ºä¸€ç­‰å…¬æ°‘**
- ğŸ”¥ **ç»“æ„åŒ–è¯­è¨€æ„ŸçŸ¥ï¼ˆAST-aware Resolverï¼‰**
- ğŸ”¥ **Intent ä¼˜åŒ– / åˆå¹¶ / æ¶ˆæ­§ç¼–è¯‘ç®¡çº¿**

ä½ å·²ç»åœ¨åšâ€œä¸‹ä¸€ä»£ç¼–è¾‘å™¨å†…æ ¸â€äº†ã€‚