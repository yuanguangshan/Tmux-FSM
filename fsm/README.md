# fsm 模块

## 模块职责概述

`fsm/` 是 **Tmux-FSM 的输入状态机**，负责将物理按键事件转换为结构化 Token。该模块只负责输入组合 → token 的转换，**永远不理解语义**，是系统的输入设备层。

主要职责包括：
- 将物理按键转换为 RawToken
- 管理输入状态（如等待后续按键）
- 提供用户界面提示和状态显示
- 将输入结果传递给 Grammar 层进行语义解析

## 核心设计思想

- **输入设备**: FSM 只是输入设备，不执行行为（NAV-002）
- **状态机**: 管理输入组合状态
- **语义无关**: 永远不理解语义，只产生 token（NAV-010）
- **实时反馈**: 通过 UI 提供状态提示

## 文件结构说明

### `keymap.go`
- 键盘映射的核心定义和加载
- 主要结构体：
  - `KeyAction`: 定义按键动作
  - `StateDef`: 定义状态定义
  - `Keymap`: 键映射配置
- 主要函数：
  - `LoadKeymap(path string) error`: 从文件加载键映射配置
  - `Validate() error`: 验证键映射配置的正确性
- 负责解析和验证 YAML 格式的键映射配置

### `engine.go`
- 状态机引擎实现
- 负责状态转换和事件处理
- 管理当前状态和状态栈

### `nvim.go`
- Neovim 集成层
- 提供与 Neovim 编辑器的通信接口
- 处理 Neovim 的输入输出

### `token.go`
- 词法分析器
- 负责解析用户输入的命令和表达式
- 提供命令的词法标记化

### `ui_stub.go`
- UI 桩实现
- 提供用户界面的占位符实现
- 用于状态显示和用户提示

## 在整体架构中的角色

FSM 模块是用户交互的前端，它接收用户的键盘输入，根据当前状态和键映射配置决定如何处理这些输入，并可能产生 Intent 传递给 Engine 层进行处理。它是连接用户输入和系统核心逻辑的桥梁。